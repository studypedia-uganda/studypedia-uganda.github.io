<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Studypedia Uganda - Your online medical resource hub for students in Uganda. Access study materials, past papers, and resources for Diploma and Certificate courses.">
  <meta name="keywords" content="studypedia, uganda, medical education, study materials, past papers, diploma courses, certificate courses, uganda medical students, online learning, nursing courses, clinical medicine">
  <meta name="author" content="Studypedia Uganda">
  <meta name="robots" content="index, follow">
  <meta name="language" content="English">
  <meta name="revisit-after" content="7 days">
  <meta name="theme-color" content="#2563eb">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://studypedia-app.firebaseapp.com/">
  <meta property="og:title" content="Studypedia Uganda - Medical Education Resources">
  <meta property="og:description" content="Your online medical resource hub for students in Uganda. Access study materials, past papers, and resources for various courses.">
  <meta property="og:image" content="https://studypedia-app.firebaseapp.com/assets/og-image.jpg">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://studypedia-app.firebaseapp.com/">
  <meta property="twitter:title" content="Studypedia Uganda - Medical Education Resources">
  <meta property="twitter:description" content="Your online medical resource hub for students in Uganda. Access study materials, past papers, and resources.">
  <meta property="twitter:image" content="https://studypedia-app.firebaseapp.com/assets/twitter-image.jpg">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://studypedia-app.firebaseapp.com/">
  
  <title>Studypedia Uganda</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
  </style>
</head>

<body class="bg-gray-50">
  <!-- Main App Container -->
  <div id="app" class="relative flex flex-col min-h-screen font-sans">
    <!-- Background Images -->
    <div id="bg-image" class="absolute inset-0 bg-cover bg-center transition-opacity duration-1000 ease-in-out"></div>

    <!-- Semi-transparent Overlay -->
    <div class="absolute inset-0 bg-blue-900 opacity-70"></div>

    <!-- Main Content Wrapper -->
    <div class="relative z-10 flex flex-col min-h-screen">
      <header class="bg-white shadow-md p-4 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <button id="menu-button" class="focus:outline-none p-2 rounded-md hover:bg-blue-50 hover:text-blue-600 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
            </svg>
          </button>
          <button id="home-button" class="text-xl md:text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-700 bg-clip-text text-transparent tracking-wide hover:scale-105 transition-transform duration-300">
            Studypedia
          </button>
          <!-- Auth Buttons -->
          <div id="auth-buttons" class="flex items-center space-x-2 ml-4">
            <!-- AI Search Bar -->
            <div id="ai-search-container" class="relative flex items-center">
              <input type="text" id="ai-search-input" placeholder="Ask AI..." class="w-32 md:w-48 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300">
              <button id="ai-search-btn" class="absolute right-1 top-1/2 transform -translate-y-1/2 bg-purple-500 text-white p-1 rounded-md hover:bg-purple-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
            </div>
            <button id="login-button" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl">
              Login
            </button>
            <button id="register-button" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl">
              Register
            </button>
            <button id="logout-button" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl hidden">
              Logout
            </button>
            <button id="seed-clt-button" class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-3 py-2 rounded-lg text-xs transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl hidden">
              Seed CLT
            </button>
            <button id="seed-diploma-button" class="ml-2 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-3 py-2 rounded-lg text-xs transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl hidden">
              Seed Diplomas
            </button>
          </div>
          <!-- AdSense Leaderboard Ad Space -->
          <div id="header-ad" class="ml-auto hidden md:block w-64 h-12 bg-gradient-to-r from-gray-200 to-gray-300 rounded shadow-md"></div>
        </div>
        <div class="flex space-x-2">
          <!-- Enhanced Back Button -->
          <button id="back-button"
            class="hidden bg-gray-200 text-gray-700 p-4 rounded-full hover:bg-gray-300 hover:shadow-lg transition-all duration-300 ease-in-out transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-50">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
          </button>
        </div>
      </header>

      <!-- Sidebar Menu -->
      <div id="sidebar"
        class="fixed top-0 left-0 h-screen transform -translate-x-full transition-transform duration-500 ease-in-out bg-gradient-to-b from-white to-blue-50 w-64 shadow-2xl z-50 overflow-y-auto border-r-2 border-blue-100">
        <div class="p-4 flex justify-end">
          <button id="close-menu-button" class="text-gray-600 hover:text-red-500 transition-all duration-300 ease-in-out transform hover:scale-110">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <nav class="p-4">
          <ul class="space-y-2">
            <li>
              <h4 class="text-lg font-bold bg-gradient-to-r from-blue-600 to-purple-700 bg-clip-text text-transparent mb-2">Courses</h4>
              <ul id="course-list" class="pl-4 space-y-2">
                <!-- Courses will be dynamically injected here -->
              </ul>

              <!-- User Profile Section -->
              <li id="user-profile-section" class="pt-4 border-t border-blue-200">
                <div id="user-info" class="text-sm text-gray-700 py-3 px-4 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 shadow-inner">
                  Loading user...
                </div>
              </li>
            </li>
            <li class="pt-4 border-t border-blue-200">
              <button id="about-nav-button"
                class="w-full text-left text-gray-700 hover:text-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 transition-all duration-300 ease-in-out py-3 px-4 rounded-xl cursor-pointer focus:outline-none focus:ring-4 focus:ring-blue-300 shadow-md hover:shadow-lg transform hover:scale-[1.02]">About
                Us</button>
            </li>
            <li>
              <button id="privacy-nav-button"
                class="w-full text-left text-gray-700 hover:text-white hover:bg-gradient-to-r hover:from-green-500 hover:to-teal-600 transition-all duration-300 ease-in-out py-3 px-4 rounded-xl cursor-pointer focus:outline-none focus:ring-4 focus:ring-green-300 shadow-md hover:shadow-lg transform hover:scale-[1.02]">Privacy
                Policy</button>
            </li>
            <li class="pt-4 border-t border-blue-200">
              <button id="admin-dashboard-button"
                class="w-full text-left text-gray-700 hover:text-white hover:bg-gradient-to-r hover:from-purple-500 hover:to-indigo-600 transition-all duration-300 ease-in-out py-3 px-4 rounded-xl cursor-pointer focus:outline-none focus:ring-4 focus:ring-purple-300 shadow-md hover:shadow-lg transform hover:scale-[1.02] hidden">Admin
                Dashboard</button>
            </li>
          </ul>
        </nav>
        <!-- AdSense Sidebar Skyscraper Ad Space -->
        <div id="sidebar-ad" class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl mt-4 border border-purple-200 shadow-md">
          <div class="w-full h-80 bg-gradient-to-br from-gray-200 to-gray-300 rounded-lg shadow-inner"></div>
        </div>
      </div>

      <!-- Main Content Area -->
      <main id="main-content" class="flex-grow p-4 md:p-8 flex items-center justify-center transition-all duration-500 ease-in-out">
        <!-- Content will be dynamically injected here -->
      </main>
    </div>

    <!-- Overlay for menu -->
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Login</h3>
          <form id="login-form">
            <div class="mb-4">
              <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your email">
            </div>
            <div class="mb-6">
              <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your password">
            </div>
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors">Login</button>
          </form>
          <p class="mt-4 text-center text-sm text-gray-600">
            Don't have an account? <button id="switch-to-register" class="text-blue-500 hover:underline">Register here</button>
          </p>
          <button id="close-login-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Register</h3>
          <form id="register-form">
            <div class="mb-4">
              <label for="register-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input type="email" id="register-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter your email">
            </div>
            <div class="mb-4">
              <label for="register-password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <input type="password" id="register-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" minlength="6" placeholder="At least 6 characters">
            </div>
            <div class="mb-6">
              <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
              <input type="password" id="register-confirm-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Confirm your password">
            </div>
            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">Register</button>
          </form>
          <p class="mt-4 text-center text-sm text-gray-600">
            Already have an account? <button id="switch-to-login" class="text-blue-500 hover:underline">Login here</button>
          </p>
          <button id="close-register-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Payment Prompt Modal -->
    <div id="payment-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
        <div class="p-6">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <svg class="w-6 h-6 text-yellow-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Payment Required
          </h3>
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <p class="text-gray-700 mb-2">To access Studypedia Uganda's premium educational resources, please complete the one-time registration payment.</p>
            <div class="bg-white rounded p-3 border border-yellow-300">
              <p class="text-lg font-bold text-gray-800">Amount: UGX 5,000</p>
              <p class="text-sm text-gray-600">Mobile Money to: +256756454646</p>
              <p class="text-sm text-gray-600">Account Name: KAIGWA AKRAM</p>
            </div>
          </div>
          <form id="payment-form">
            <div class="mb-4">
              <label for="payment-reference" class="block text-sm font-medium text-gray-700 mb-2">Payment Reference/Transaction ID</label>
              <input type="text" id="payment-reference" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your payment reference or transaction ID">
            </div>
            <div class="mb-6">
              <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
              <select id="payment-method" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select Payment Method</option>
                <option value="MTN Mobile Money">MTN Mobile Money</option>
                <option value="Airtel Money">Airtel Money</option>
              </select>
            </div>
            <button type="submit" id="payment-submit-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-colors" onclick="this.textContent='Submitting...'">Submit Payment Details</button>
          </form>
          <p class="mt-4 text-center text-sm text-gray-600">
            <button id="contact-admin" class="text-blue-500 hover:underline">Contact Admin</button> |
            <button id="logout-instead" class="text-red-500 hover:underline">Logout Instead</button>
          </p>
          <button id="close-payment-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK Imports -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, writeBatch, setLogLevel, onSnapshot, query, collectionGroup, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyBZLoJZVVCVAWafhd4Oh8bhEGV4waN1B5g",
      authDomain: "studypedia-app.firebaseapp.com",
      projectId: "studypedia-app",
      storageBucket: "studypedia-app.firebasestorage.app",
      messagingSenderId: "793261754970",
      appId: "1:793261754970:web:49bbd2bea1ab4d46486663",
      measurementId: "G-6CTGP0MF8Y"
    };

    // These global variables are provided by the canvas environment.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let db;
    let auth;
    let user;
    let isMenuOpen = false;
    let currentPage = 'home';
    let selectedCourse = null;
    let selectedSemester = null;
    let selectedCourseUnit = null;

    let courses = [];
    let semesters = [];
    let courseUnits = [];
    let documents = [];

    // Payment system variables
    let paymentModalShown = false;
    let paymentSubmitted = false;
    let isSubmittingPayment = false;

    // Debug variables
    let authStateChangeCount = 0;
    let loginInProgress = false;

    // FIX: Move reload flag outside auth state handler and use sessionStorage for persistence
    // Check if we've already reloaded for this user in this session
    const reloadKey = 'hasReloadedForApproval';
    let hasReloadedForApproval = sessionStorage.getItem(reloadKey) === 'true';

    // UI elements
    const mainContent = document.getElementById('main-content');
    const sidebar = document.getElementById('sidebar');
    const menuOverlay = document.getElementById('menu-overlay');
    const backButton = document.getElementById('back-button');
    const courseList = document.getElementById('course-list');
    const bgImageDiv = document.getElementById('bg-image');
    const coursesButton = document.getElementById('courses-button');
    const aboutButton = document.getElementById('about-button');
    const privacyButton = document.getElementById('privacy-button');

    // Auth UI elements
    const loginButton = document.getElementById('login-button');
    const registerButton = document.getElementById('register-button');
    const logoutButton = document.getElementById('logout-button');
    const loginModal = document.getElementById('login-modal');
    const registerModal = document.getElementById('register-modal');
    const paymentModal = document.getElementById('payment-modal');
    const closeLoginModal = document.getElementById('close-login-modal');
    const closeRegisterModal = document.getElementById('close-register-modal');
    const closePaymentModal = document.getElementById('close-payment-modal');
    const switchToRegister = document.getElementById('switch-to-register');
    const switchToLogin = document.getElementById('switch-to-login');
    const contactAdmin = document.getElementById('contact-admin');
    const logoutInstead = document.getElementById('logout-instead');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const paymentForm = document.getElementById('payment-form');
    const seedButton = document.getElementById('seed-clt-button');
    
    // AI Search elements
    const aiSearchInput = document.getElementById('ai-search-input');
    const aiSearchBtn = document.getElementById('ai-search-btn');
    
    // Groq API Configuration
    const GROQ_API_KEY = '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';
    const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
    
    // AI Search context - Information about Studypedia Uganda
    const AI_CONTEXT = `You are an AI assistant for Studypedia Uganda, an online medical education platform for students in Uganda. 
    The platform provides study materials, past papers, and resources for various courses including:
    - Certificate in Clinical Medicine (CLT)
    - Diploma in Clinical Medicine
    - Nursing courses
    - Other medical-related courses
    
    Users can browse courses, view semesters, access course units, and download documents.
    The platform requires a one-time payment of UGX 5,000 for access.
    Payment is made via Mobile Money to: +256756454646 (KAIGWA AKRAM)
    
    Please provide helpful, accurate responses about studying in Uganda and medical education.`;
    
    // AI Search function
    async function performAISearch(query) {
      if (!query.trim()) return;
      
      // Show loading state
      aiSearchBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
      aiSearchBtn.disabled = true;
      
      try {
        const response = await fetch(GROQ_API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${GROQ_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'llama-3.1-8b-instant',
            messages: [
              {
                role: 'system',
                content: AI_CONTEXT
              },
              {
                role: 'user',
                content: query
              }
            ],
            temperature: 0.7,
            max_tokens: 500,
            top_p: 0.9,
            stream: false
          })
        });
        
        if (!response.ok) {
          throw new Error('API request failed');
        }
        
        const data = await response.json();
        const aiResponse = data.choices[0]?.message?.content || 'No response received.';
        
        // Display the AI response in an alert or modal
        showAIResponseModal(aiResponse);
        
      } catch (error) {
        console.error('AI Search Error:', error);
        alert('Sorry, I encountered an error processing your request. Please try again.');
      } finally {
        // Reset button state
        aiSearchBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>';
        aiSearchBtn.disabled = false;
      }
    }
    
    // Show AI Response in a modal
    function showAIResponseModal(response) {
      // Create modal if it doesn't exist
      let modal = document.getElementById('ai-response-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'ai-response-modal';
        modal.className = 'fixed inset-0 z-50 hidden flex items-center justify-center p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden">
            <div class="p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                  <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                  AI Assistant
                </h3>
                <button id="close-ai-modal" class="text-gray-400 hover:text-gray-600">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <div id="ai-response-content" class="prose max-h-96 overflow-y-auto text-gray-700 leading-relaxed"></div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Add close event listener
        document.getElementById('close-ai-modal').addEventListener('click', () => {
          modal.classList.add('hidden');
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.add('hidden');
          }
        });
      }
      
      // Set content and show modal
      document.getElementById('ai-response-content').innerHTML = response.replace(/\n/g, '<br>');
      modal.classList.remove('hidden');
    }
    
    // Event listeners for AI search
    aiSearchBtn.addEventListener('click', () => {
      performAISearch(aiSearchInput.value);
    });
    
    aiSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performAISearch(aiSearchInput.value);
      }
    });
// Global access verification function
async function verifyCourseAccess() {
  if (!user || user.isAnonymous || user.email === 'kaigwaakram123@gmail.com') {
    return true; // Anonymous users and admin have access
  }

  try {
    const paymentStatus = await checkPaymentStatus(user.uid);
    return paymentStatus.hasPaid || paymentStatus.status === 'none';
  } catch (error) {
    console.error('Error verifying course access:', error);
    return false;
  }
}

// Auth functions
async function registerUser(email, password) {
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    console.log('User registered:', userCredential.user);

    // Initialize payment status for new user
    await setDoc(doc(db, 'user_payments', userCredential.user.uid), {
      userId: userCredential.user.uid,
      userEmail: email,
      status: 'pending',
      amount: 5000,
      registeredAt: new Date(),
      isNewUser: true
    });

    alert('Registration successful! Please complete the payment to access the platform.');
    hideModal(registerModal);

    // Show payment modal for new users only
    setTimeout(() => {
      showPaymentModal();
    }, 500);

    return userCredential.user;
  } catch (error) {
    console.error('Registration error:', error);
    alert('Registration failed: ' + error.message);
  }
}

async function loginUser(email, password) {
  try {
    console.log('üîê Attempting login for:', email);
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    console.log('‚úÖ User logged in successfully:', userCredential.user.uid);

    // Check if user is new or existing
    console.log('üîç Checking payment status...');
    const paymentStatus = await checkPaymentStatus(userCredential.user.uid);
    console.log('üí≥ Payment status:', paymentStatus);

    if (paymentStatus.hasPaid || paymentStatus.status === 'none') {
      // Existing user with approved payment or no payment record (legacy user)
      console.log('‚úÖ Existing user has access, redirecting to homepage');

      // Update UI immediately
      updateAuthUI(true, userCredential.user);
      updateUserInfo();

      alert('Login successful! Welcome back.');
      hideModal(loginModal);

      // Redirect to homepage for existing users
      setTimeout(() => {
        goToPage('home');
        console.log('üîÑ Redirected existing user to homepage');
      }, 500);
    } else {
      // User with pending payment (new user who hasn't paid yet)
      console.log('‚è≥ New user needs payment approval, showing payment modal');

      // Update UI immediately for new users too
      updateAuthUI(true, userCredential.user);
      updateUserInfo();

      alert('Login successful! Please complete the payment to access the platform.');
      hideModal(loginModal);

      // Show payment modal for new users
      setTimeout(() => {
        console.log('ü™ü Showing payment modal for new user...');
        showPaymentModal();
      }, 500);
    }

    return userCredential.user;
  } catch (error) {
    console.error('‚ùå Login error:', error);
    alert('Login failed: ' + error.message);
  }
}

async function logoutUser() {
  try {
    await signOut(auth);
    console.log('User logged out');
    alert('Logged out successfully.');
  } catch (error) {
    console.error('Logout error:', error);
    alert('Logout failed: ' + error.message);
  }
}

function updateAuthUI(isLoggedIn, user) {
  if (isLoggedIn && user) {
    // Hide login/register buttons immediately
    loginButton.classList.add('hidden');
    registerButton.classList.add('hidden');
    // Show logout button
    logoutButton.classList.remove('hidden');
    // Keep seed buttons hidden - deactivated
    seedButton.classList.add('hidden');
    document.getElementById('seed-diploma-button').classList.add('hidden');
    logoutButton.textContent = `Logout (${user.email || user.uid.substring(0,8)}...)`;

    // Show admin buttons if user is admin
    if (user.email === 'kaigwaakram123@gmail.com') {
      showAdminAccessButton();
    }

    console.log('‚úÖ Auth UI updated - login/register hidden, logout shown');
  } else {
    // Show login/register buttons
    loginButton.classList.remove('hidden');
    registerButton.classList.remove('hidden');
    // Hide logout button
    logoutButton.classList.add('hidden');
    seedButton.classList.add('hidden');
    document.getElementById('seed-diploma-button').classList.add('hidden');

    // Hide admin buttons when logged out
    hideAdminButtons();

    console.log('‚úÖ Auth UI updated - login/register shown, logout hidden');
  }
}

function hideAdminButtons() {
  const adminButton = document.getElementById('admin-dashboard-button');
  if (adminButton) {
    adminButton.classList.add('hidden');
  }

  const adminAccessSection = document.getElementById('admin-access-section');
  if (adminAccessSection) {
    adminAccessSection.classList.add('hidden');
  }
}

    // Modal functions
    function showModal(modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

function updateUserInfo() {
  const userInfo = document.getElementById('user-info');
  if (user && !user.isAnonymous) {
    userInfo.innerHTML = `
      <div class="flex items-center space-x-2">
        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        <span>Logged in as: ${user.email}</span>
      </div>
    `;
    userInfo.classList.remove('bg-gray-50');
    userInfo.classList.add('bg-blue-50', 'border', 'border-blue-200');
  } else if (user && user.isAnonymous) {
    userInfo.innerHTML = `
      <div class="flex items-center space-x-2">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        <span>Guest User</span>
      </div>
    `;
    userInfo.classList.remove('bg-blue-50', 'border', 'border-blue-200');
    userInfo.classList.add('bg-gray-50');
  } else {
    userInfo.textContent = 'Loading user...';
  }
}
    function hideModal(modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Payment modal functions
    function showPaymentModal() {
      console.log('ü™ü showPaymentModal() called, paymentModalShown:', paymentModalShown);

      // Prevent showing modal multiple times
      if (paymentModalShown) {
        console.log('‚ö†Ô∏è Payment modal already shown, ignoring duplicate call');
        return;
      }

      paymentModalShown = true;
      showModal(paymentModal);
      console.log('‚úÖ Payment modal displayed');
    }

    function hidePaymentModal() {
      console.log('üîí hidePaymentModal() called');
      hideModal(paymentModal);
      // Reset submission flag when modal is closed
      isSubmittingPayment = false;
      console.log('‚úÖ Payment modal hidden');
    }

    // Check if user has paid and been approved
    async function checkPaymentStatus(userId) {
      try {
        const paymentDoc = await getDoc(doc(db, 'user_payments', userId));
        if (paymentDoc.exists()) {
          const paymentData = paymentDoc.data();
          return {
            hasPaid: paymentData.status === 'approved',
            status: paymentData.status,
            paymentDate: paymentData.paymentDate,
            approvedDate: paymentData.approvedDate,
            isNewUser: paymentData.isNewUser || false,
            registeredAt: paymentData.registeredAt
          };
        }
        return {
          hasPaid: false,
          status: 'none',
          isNewUser: false
        };
      } catch (error) {
        console.error('Error checking payment status:', error);
        return {
          hasPaid: false,
          status: 'error',
          isNewUser: false
        };
      }
    }

    // Submit payment details
    async function submitPaymentDetails(reference, method) {
      try {
        // Prevent multiple simultaneous submissions
        if (isSubmittingPayment) {
          console.log('‚ö†Ô∏è Payment submission already in progress, ignoring duplicate call');
          return;
        }

        isSubmittingPayment = true;
        console.log('üîÑ Starting payment submission...');

        // Get current authenticated user directly from Firebase Auth
        const currentUser = auth.currentUser;
        console.log('Current Firebase Auth user:', currentUser);
        console.log('User ID:', currentUser?.uid);
        console.log('User email:', currentUser?.email);
        console.log('User isAnonymous:', currentUser?.isAnonymous);

        // Enhanced user authentication check using current Firebase Auth user
        if (!currentUser) {
          throw new Error('User not authenticated. Please log in again.');
        }

        if (currentUser.isAnonymous) {
          throw new Error('User not authenticated. Please log in again.');
        }

        if (!currentUser.uid || !currentUser.email) {
          throw new Error('User ID or email is missing. Please log in again.');
        }

        if (!reference || reference.trim().length < 3) {
          throw new Error('Please enter a valid payment reference (at least 3 characters)');
        }

        if (!method) {
          throw new Error('Please select a payment method');
        }

        const paymentData = {
          userId: currentUser.uid,
          userEmail: currentUser.email,
          paymentReference: reference,
          paymentMethod: method,
          amount: 5000,
          status: 'pending',
          paymentDate: new Date(),
          submittedAt: new Date(),
          isNewUser: true
        };

        console.log('‚úÖ Payment data prepared:', paymentData);

        console.log('üìù Payment data to be saved:', paymentData);

        // Save to user_payments collection
        console.log('üíæ Saving to user_payments collection...');
        await setDoc(doc(db, 'user_payments', user.uid), paymentData);
        console.log('‚úÖ Payment data saved successfully');

        // Also add to admin notifications
        console.log('üîî Creating admin notification...');
        await addDoc(collection(db, 'payment_notifications'), {
          ...paymentData,
          type: 'new_payment',
          createdAt: new Date()
        });
        console.log('‚úÖ Admin notification created');

        // Reset button text on success
        const submitBtn = document.getElementById('payment-submit-btn');
        if (submitBtn) submitBtn.textContent = 'Submit Payment Details';

        return true;
      } catch (error) {
        console.error('‚ùå Error submitting payment:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);

        // Reset button text on error
        const submitBtn = document.getElementById('payment-submit-btn');
        if (submitBtn) submitBtn.textContent = 'Submit Payment Details';

        throw error;
      } finally {
        // Reset submission flag
        isSubmittingPayment = false;
      }
    }


    const bgImages = Array.from({ length: 30 }, (_, i) => `https://picsum.photos/1920/1080?random=${i + 1}&blur=2`);
    let bgImageIndex = 0;

    function cycleBgImages() {
      // Background image cycling disabled to prevent potential issues
      console.log('Background image cycling disabled to prevent reload issues');
      // setInterval(() => {
      //   bgImageIndex = (bgImageIndex + 1) % bgImages.length;
      //   bgImageDiv.style.backgroundImage = `url('${bgImages[bgImageIndex]}')`;
      // }, 20000); // Change image every 20 seconds
    }

    // State Management and Rendering Functions
    function toggleMenu() {
      isMenuOpen = !isMenuOpen;
      sidebar.classList.toggle('-translate-x-full', !isMenuOpen);
      menuOverlay.classList.toggle('hidden', !isMenuOpen);
      if (isMenuOpen) {
        document.body.style.overflow = 'hidden'; // Lock background scroll

        // BLOCK unapproved users from accessing courses in menu
        if (user && user.email === 'kaigwaakram123@gmail.com') {
          fetchCourses(); // Admin has full access
        } else if (user && !user.isAnonymous) {
          // Check payment status for regular users - BLOCK unapproved users
          checkPaymentStatus(user.uid).then(paymentStatus => {
            if (paymentStatus.hasPaid || paymentStatus.status === 'none') {
              fetchCourses(); // User has approved payment or legacy access
            } else {
              // User has pending payment - BLOCK menu access to courses
              courseList.innerHTML = `
                <li class="text-red-600 font-semibold p-4 bg-red-50 rounded-lg border border-red-200">
                  ‚õî Course access requires admin approval.<br>
                  <span class="text-sm">Please wait for your payment to be approved.</span>
                </li>
              `;
            }
          }).catch(error => {
            console.error('Error checking payment status in menu:', error);
            courseList.innerHTML = `<li class="text-red-500">Error loading courses</li>`;
          });
        } else {
          // Anonymous users can browse course listings only
          fetchCourses();
        }
      } else {
        document.body.style.overflow = ''; // Restore scroll
      }

      // Ensure sidebar scroll works by preventing wheel event bubbling
      const wheelHandler = function (e) {
        e.stopPropagation();
      };
      if (isMenuOpen) {
        sidebar.addEventListener('wheel', wheelHandler, { passive: false });
      } else {
        sidebar.removeEventListener('wheel', wheelHandler);
      }
    }

    function goToPage(page, keepOpen = false) {
      // GLOBAL ACCESS CHECK: If unapproved user tries to access courses, block immediately
      if (page === 'courses' && user && !user.isAnonymous && user.email !== 'kaigwaakram123@gmail.com') {
        checkPaymentStatus(user.uid).then(paymentStatus => {
          if (!paymentStatus.hasPaid && paymentStatus.status !== 'none') {
            // Block unapproved user from courses page
            mainContent.innerHTML = `
              <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‚õî Access Denied</h2>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                  <p class="text-gray-700 font-semibold">You must wait for admin approval before accessing courses.</p>
                  <p class="text-sm text-gray-600 mt-2">Your payment is being reviewed. Access will be granted once approved.</p>
                </div>
                <button onclick="showPaymentModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors mr-2">
                  View Payment Details
                </button>
                <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                  Return to Homepage
                </button>
              </div>
            `;
            console.log('üö´ Global access check blocked unapproved user from courses');
            return; // Don't proceed with navigation
          }
        }).catch(error => {
          console.error('Error in global access check:', error);
          goToPage('home'); // Redirect to home on error
          return;
        });
      }

      currentPage = page;
      if (!keepOpen) {
        // Explicitly close menu on navigation unless keeping open
        isMenuOpen = false;
        sidebar.classList.add('-translate-x-full');
        menuOverlay.classList.add('hidden');
      }
      backButton.classList.toggle('hidden', page === 'home' || page === 'courses');

      if (page === 'courses') {
        // Check if user has permission to access courses
        if (user && user.email === 'kaigwaakram123@gmail.com') {
          fetchCourses(); // Admin has full access
        } else if (user && !user.isAnonymous) {
          // Check payment status for regular users - BLOCK unapproved users completely
          checkPaymentStatus(user.uid).then(paymentStatus => {
            if (paymentStatus.hasPaid || paymentStatus.status === 'none') {
              fetchCourses(); // User has approved payment or legacy access
            } else {
              // User has pending payment - BLOCK access completely, don't show courses page
              mainContent.innerHTML = `
                <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                  <h2 class="text-2xl font-bold text-gray-800 mb-4">‚õî Access Denied</h2>
                  <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <p class="text-gray-700 font-semibold">You must wait for admin approval before accessing courses.</p>
                    <p class="text-sm text-gray-600 mt-2">Your payment is being reviewed. You will be able to access all courses once approved.</p>
                  </div>
                  <button onclick="showPaymentModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors mr-2">
                    View Payment Details
                  </button>
                  <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                    Return to Homepage
                  </button>
                </div>
              `;
              console.log('üö´ Unapproved user blocked from courses page');
              return; // Don't render courses page content
            }
          }).catch(error => {
            console.error('Error checking payment status:', error);
            mainContent.innerHTML = `
              <div class="p-8 bg-red-100 text-red-800 rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                <h2 class="text-2xl font-bold mb-4">Access Verification Error</h2>
                <p>Unable to verify your access permissions. Please contact admin for assistance.</p>
                <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors mt-4">
                  Return to Homepage
                </button>
              </div>
            `;
            return; // Don't render courses page content
          });
        } else {
          // Anonymous users can browse course listings only
          fetchCourses();
        }
      }

      if (page === 'admin-dashboard') {
        loadAdminDashboard();
      }
      renderContent();

      // Ensure admin buttons remain visible for admin users when navigating
      if (user && user.email === 'kaigwaakram123@gmail.com' && page === 'home') {
        showAdminAccessButton();
      }

      // Show welcome message for logged-in users on homepage
      if (page === 'home' && user && !user.isAnonymous) {
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) {
          welcomeMessage.classList.remove('hidden');
        }
      }

      // Continuous protection: If unapproved user is on courses page, redirect immediately
      if (page === 'courses' && user && !user.isAnonymous && user.email !== 'kaigwaakram123@gmail.com') {
        setTimeout(async () => {
          const hasAccess = await verifyCourseAccess();
          if (!hasAccess) {
            console.log('üö´ Continuous protection: Redirecting unapproved user from courses page');
            goToPage('home');
          }
        }, 100); // Small delay to allow other checks to complete
      }
    }

    function handleCourseSelection(courseId) {
      selectedCourse = courseId;
      selectedSemester = null;
      selectedCourseUnit = null;
      // For main page, expand semesters inline (prioritize over sidebar)
      const mainCourseItem = document.querySelector('.course-item-main[data-course-id="' + courseId + '"]');
      if (mainCourseItem) {
        toggleMainCourseSemesters(courseId);
        return;
      }
      // For sidebar, expand semesters in sidebar
      const sidebarCourseItem = document.querySelector('.course-item[data-course-id="' + courseId + '"]');
      if (sidebarCourseItem) {
        toggleCourseSemesters(courseId);
        return;
      }
      // Fallback navigation
      goToPage('course-semesters');
      fetchSemesters();
    }

    window.handleCourseSelection = handleCourseSelection;
    window.goToPage = goToPage;

    function toggleCourseSemesters(courseId) {
      const courseItem = document.querySelector('.course-item[data-course-id="' + courseId + '"]');
      if (courseItem) {
        const semestersList = courseItem.querySelector('.semesters-list');
        const arrow = courseItem.querySelector('.arrow');
        if (semestersList) {
          const isVisible = semestersList.classList.contains('hidden');
          semestersList.classList.toggle('hidden', !isVisible);
          if (isVisible) {
            // Load semesters if not loaded
            loadCourseSemestersInSidebar(courseId);
          }
        }
      }
    }

    function toggleMainCourseSemesters(courseId) {
      const courseItem = document.querySelector('.course-item-main[data-course-id="' + courseId + '"]');
      if (courseItem) {
        const semestersList = courseItem.querySelector('.semesters-list-main');
        if (semestersList) {
          const isVisible = semestersList.classList.contains('hidden');
          semestersList.classList.toggle('hidden', !isVisible);
          if (isVisible) {
            // Load semesters if not loaded
            loadMainCourseSemesters(courseId);
          } else {
            // Clear semesters when collapsing to save space
            semestersList.innerHTML = '';
          }
        }
      }
    }

    async function loadMainCourseSemesters(courseId) {
      const semestersList = document.querySelector(`.course-item-main[data-course-id="${courseId}"] .semesters-list-main`);
      if (semestersList && semestersList.children.length === 0) {
        try {
          semestersList.innerHTML = renderLoading('Loading semesters...');
          const semestersRef = collection(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters`);
          const snapshot = await getDocs(semestersRef);
          const semestersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          semesters = semestersData; // Update global semesters array for consistent rendering
          if (semestersData.length > 0) {
            semestersList.innerHTML = semestersData.map(sem => `
                            <div class="select-semester-main w-full text-left bg-gray-50 text-gray-700 py-3 px-4 rounded-lg shadow-sm hover:bg-gray-100 cursor-pointer transition-all duration-200 ${selectedSemester === sem.id ? 'bg-blue-100' : ''}" data-semester-id="${sem.id}" data-course-id="${courseId}" style="user-select: none;">
                                ${sem.name}
                            </div>
                        `).join('');
          } else {
            semestersList.innerHTML = '<p class="text-center text-gray-500 py-4">No semesters available for this course.</p>';
          }
        } catch (error) {
          console.error('Error loading semesters on main page:', error);
          semestersList.innerHTML = '<p class="text-center text-red-500 py-4">Failed to load semesters. Please try again.</p>';
        }
      }
    }

    async function loadCourseSemestersInSidebar(courseId) {
      const semestersList = document.querySelector(`.course-item[data-course-id="${courseId}"] .semesters-list`);
      if (semestersList && semestersList.children.length === 0) {
        try {
          const semestersRef = collection(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters`);
          const snapshot = await getDocs(semestersRef);
          const localSemesters = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          semesters = localSemesters; // Update global semesters array for consistent rendering
          semestersList.innerHTML = localSemesters.map(sem => `
                        <li class="pl-6 py-1">
                            <button class="sidebar-semester w-full text-left text-gray-600 hover:text-blue-600 hover:bg-gray-50 transition-colors py-1 px-2 rounded cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 ${selectedSemester === sem.id ? 'active-menu' : ''}" data-semester-id="${sem.id}" data-course-id="${courseId}">
                                ${sem.name}
                            </button>
                        </li>
                    `).join('');
        } catch (error) {
          console.error('Error loading semesters in sidebar:', error);
          semestersList.innerHTML = '<li class="text-red-500 pl-6">Error loading semesters</li>';
        }
      }
    }

    function handleSemesterSelection(semesterId, fromSidebar = false, fromMain = false) {
      selectedSemester = semesterId;
      selectedCourseUnit = null;
      if (fromSidebar) {
        // From sidebar, navigate but keep menu open
        goToPage('semester-courseunits', true);
        fetchCourseUnits();
      } else if (fromMain) {
        // From main page, navigate and close any expansions if needed
        goToPage('semester-courseunits');
        fetchCourseUnits();
      } else {
        goToPage('semester-courseunits');
        fetchCourseUnits();
      }
    }

    async function loadSemesterCourseUnitsInSidebar(courseId, semesterId) {
      // For now, navigate to main page; can extend to nested if needed
      goToPage('semester-courseunits');
      fetchCourseUnits();
    }

    function handleCourseUnitSelection(courseUnitId) {
      selectedCourseUnit = courseUnitId;
      goToPage('document-viewer', false); // Close menu for document viewer
      fetchDocuments();
    }

    function updateMenuHighlights() {
      // Remove all active classes
      document.querySelectorAll('.select-course, .sidebar-semester, #about-nav-button, #privacy-nav-button').forEach(el => el.classList.remove('active-menu'));

      // Highlight selected course in sidebar
      if (selectedCourse && isMenuOpen) {
        const courseBtn = document.querySelector(`.select-course[data-course-id="${selectedCourse}"]`);
        if (courseBtn) courseBtn.classList.add('active-menu');
      }

      // Highlight selected semester if visible
      if (selectedSemester && isMenuOpen) {
        const semesterBtn = document.querySelector(`.sidebar-semester[data-semester-id="${selectedSemester}"]`);
        if (semesterBtn) semesterBtn.classList.add('active-menu');
      }

      // Highlight about/privacy if current page
      if (currentPage === 'about') {
        document.getElementById('about-nav-button').classList.add('active-menu');
      } else if (currentPage === 'privacy') {
        document.getElementById('privacy-nav-button').classList.add('active-menu');
      }
    }

    function handleBack() {
      if (currentPage === 'document-viewer') {
        selectedCourseUnit = null;
        goToPage('semester-courseunits');
      } else if (currentPage === 'semester-courseunits') {
        selectedSemester = null;
        goToPage('course-semesters');
      } else if (currentPage === 'course-semesters') {
        selectedCourse = null;
        goToPage('courses'); // This will be blocked by access control if user is unapproved
      } else if (currentPage === 'courses') {
        goToPage('home');
      } else if (currentPage === 'about' || currentPage === 'privacy' || currentPage === 'admin-dashboard') {
        goToPage('home');
      }
    }

    async function handleViewDocument(docData) {
      console.log('Attempting to view document:', docData);
      try {
        let url;
        if (docData.filePath && docData.filePath.startsWith('http')) {
          // Direct external link (e.g., Google Drive)
          url = docData.filePath;
          console.log('Using external URL:', url);
        } else if (docData.filePath) {
          // Firebase Storage path
          const storage = getStorage();
          const fileRef = ref(storage, docData.filePath);
          url = await getDownloadURL(fileRef);
          console.log('Generated Firebase Storage URL:', url);
        } else {
          throw new Error('Missing filePath');
        }
        window.open(url, '_blank');
        console.log('Document opened in new tab');
      } catch (error) {
        console.error('Error accessing document for viewing:', error, 'Document data:', docData);
        const title = docData.title || 'this document';
        if (!docData.filePath) {
          alert(`Cannot view "${title}". Missing 'filePath' in Firebase document. Add a valid URL (e.g., Google Drive link) or Storage path to this document in Firestore.`);
        } else if (docData.filePath.startsWith('http')) {
          alert(`Failed to open external link for "${title}". URL: ${docData.filePath}. Check if it's public and accessible. Error: ${error.message}`);
        } else {
          let errorMsg = `Failed to load "${title}" from Firebase Storage. Path: ${docData.filePath}. `;
          if (error.code === 'storage/object-not-found') {
            errorMsg += 'File not found‚Äîupload it to Firebase Storage at this path and ensure public access.';
          } else if (error.code === 'storage/unauthorized') {
            errorMsg += 'Access denied‚Äîmake the file public in Firebase Storage rules.';
          } else {
            errorMsg += 'General error. ';
          }
          errorMsg += `Full error: ${error.message}\n\nRequired: 'title' (string), 'filePath' (URL or Storage path).`;
          alert(errorMsg);
        }
      }
    }
    
    async function handleDownloadDocument(docData) {
      console.log('Attempting to download document:', docData);
      try {
        let url;
        if (docData.filePath && docData.filePath.startsWith('http')) {
          // Direct external link (e.g., Google Drive)
          url = docData.filePath;
          console.log('Using external URL for download:', url);
        } else if (docData.filePath) {
          // Firebase Storage path
          const storage = getStorage();
          const fileRef = ref(storage, docData.filePath);
          url = await getDownloadURL(fileRef);
          console.log('Generated Firebase Storage URL for download:', url);
        } else {
          throw new Error('Missing filePath');
        }
        const filename = docData.title ? `${docData.title.replace(/[^a-z0-9]/gi, '_')}.pdf` : 'document.pdf';
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        console.log(`Download initiated for: ${filename}`);
      } catch (error) {
        console.error('Error accessing document for download:', error, 'Document data:', docData);
        const title = docData.title || 'this document';
        if (!docData.filePath) {
          alert(`Cannot download "${title}". Missing 'filePath' in Firebase document. Add a valid URL or Storage path to this document in Firestore.`);
        } else if (docData.filePath.startsWith('http')) {
          alert(`Failed to download external file "${title}". URL: ${docData.filePath}. Ensure it's downloadable and public. Error: ${error.message}`);
        } else {
          let errorMsg = `Failed to download "${title}" from Firebase Storage. Path: ${docData.filePath}. `;
          if (error.code === 'storage/object-not-found') {
            errorMsg += 'File not found‚Äîupload it to Firebase Storage at this path and make public.';
          } else if (error.code === 'storage/unauthorized') {
            errorMsg += 'Access denied‚Äîset Storage rules to allow public read.';
          } else {
            errorMsg += 'General error. ';
          }
          errorMsg += `Full error: ${error.message}\n\nRequired: 'title' (string), 'filePath' (URL or Storage path).`;
          alert(errorMsg);
        }
      }
    }

    // Temporary cleanup function to remove sample data
    async function cleanupSampleData() {
      try {
        console.log('Starting cleanup of sample data...');

        // Delete all documents in a collection using batches
        async function deleteCollectionDocs(collectionPath) {
          const collectionRef = collection(db, collectionPath);
          const snapshot = await getDocs(collectionRef);
          if (snapshot.empty) {
            console.log(`No documents in ${collectionPath}`);
            return;
          }

          const batch = writeBatch(db);
          snapshot.docs.forEach((doc) => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          console.log(`Deleted ${snapshot.size} documents from ${collectionPath}`);
        }

        // Sample data patterns to target for deletion
        const sampleCourses = ['Medical Laboratory Science Diploma', 'Nursing Certificate', 'Pharmacy Diploma', 'Clinical Medicine Diploma'];
        const sampleSemesters = ['Semester 1', 'Semester 2'];
        const sampleCourseUnits = ['Anatomy Basics', 'Physiology', 'Pharmacology Introduction'];
        const sampleDocuments = ['Lecture Notes Chapter 1', 'Past Paper 2023', 'Study Guide'];

        // Targeted deletion function for sample data only
        async function deleteSampleDataOnly() {
          try {
            // Delete sample documents in all courseunits
            const allDocsQuery = query(collectionGroup(db, 'documents'));
            const docsSnapshot = await getDocs(allDocsQuery);
            const sampleDocsToDelete = docsSnapshot.docs.filter(doc =>
              sampleDocuments.includes(doc.data().title)
            );
            if (sampleDocsToDelete.length > 0) {
              const batch = writeBatch(db);
              sampleDocsToDelete.forEach(doc => batch.delete(doc.ref));
              await batch.commit();
              console.log(`Deleted ${sampleDocsToDelete.length} sample documents`);
            }

            // Delete sample course units
            const allUnitsQuery = query(collectionGroup(db, 'courseunits'));
            const unitsSnapshot = await getDocs(allUnitsQuery);
            const sampleUnitsToDelete = unitsSnapshot.docs.filter(doc =>
              sampleCourseUnits.includes(doc.data().name)
            );
            if (sampleUnitsToDelete.length > 0) {
              const batch = writeBatch(db);
              sampleUnitsToDelete.forEach(unit => batch.delete(unit.ref));
              await batch.commit();
              console.log(`Deleted ${sampleUnitsToDelete.length} sample course units`);
            }

            // Delete sample semesters
            const allSemestersQuery = query(collectionGroup(db, 'semesters'));
            const semestersSnapshot = await getDocs(allSemestersQuery);
            const sampleSemestersToDelete = semestersSnapshot.docs.filter(doc =>
              sampleSemesters.includes(doc.data().name)
            );
            if (sampleSemestersToDelete.length > 0) {
              const batch = writeBatch(db);
              sampleSemestersToDelete.forEach(sem => batch.delete(sem.ref));
              await batch.commit();
              console.log(`Deleted ${sampleSemestersToDelete.length} sample semesters`);
            }

            // Delete sample courses
            const coursesRef = collection(db, 'RESOURCES_STUDYPEDIA');
            const coursesSnapshot = await getDocs(coursesRef);
            const sampleCoursesToDelete = coursesSnapshot.docs.filter(doc =>
              sampleCourses.includes(doc.data().name)
            );
            if (sampleCoursesToDelete.length > 0) {
              const batch = writeBatch(db);
              sampleCoursesToDelete.forEach(course => batch.delete(course.ref));
              await batch.commit();
              console.log(`Deleted ${sampleCoursesToDelete.length} sample courses`);
            }

            console.log('Targeted cleanup of sample data completed!');
            return true;
          } catch (error) {
            console.error('Error in targeted cleanup:', error);
            throw error;
          }
        }

        // Perform targeted deletion of sample data only
        const success = await deleteSampleDataOnly();
        if (success) {
          // Hide the cleanup button after successful deletion
          const button = document.getElementById('clear-sample-data');
          if (button) {
            button.style.display = 'none';
          }
          alert('Sample data cleared successfully! Only your manually saved data remains. Refresh the page to see the updated state.');
          // location.reload(); // Refresh to update the UI (disabled to prevent reload loops)
          console.log('Sample data cleared successfully! Refresh the page manually to see the updated state.');
        }
      } catch (error) {
        console.error('Error during cleanup:', error);
        alert('Error clearing sample data. Check console for details: ' + error.message);
      }
    }

    function renderLoading(message) {
      return `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"></div>
                    <p class="mt-4 text-gray-500">${message}</p>
                </div>
            `;
    }

    function renderContent() {
      // Additional safety check: If on courses page but not authorized, block access
      if (currentPage === 'courses' && user && !user.isAnonymous && user.email !== 'kaigwaakram123@gmail.com') {
        checkPaymentStatus(user.uid).then(paymentStatus => {
          if (!paymentStatus.hasPaid && paymentStatus.status !== 'none') {
            mainContent.innerHTML = `
              <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‚õî Access Denied</h2>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                  <p class="text-gray-700 font-semibold">You must wait for admin approval before accessing courses.</p>
                  <p class="text-sm text-gray-600 mt-2">Your payment is being reviewed. Access will be granted once approved.</p>
                </div>
                <button onclick="showPaymentModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors mr-2">
                  View Payment Details
                </button>
                <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                  Return to Homepage
                </button>
              </div>
            `;
            console.log('üö´ Render check blocked unapproved user from courses page');
            return; // Don't render courses content
          }
        }).catch(error => {
          console.error('Error in render access check:', error);
          goToPage('home'); // Redirect on error
          return;
        });
      }

      let contentHTML = '';
      switch (currentPage) {
        case 'home':
          contentHTML = `
                        <div class="text-center p-8 flex flex-col items-center justify-center h-full">
                            <h1 class="text-5xl md:text-6xl font-extrabold text-white mb-4 animate-fade-in drop-shadow-lg">Studypedia Uganda</h1>
                            <p class="text-xl md:text-2xl text-white mb-8 animate-fade-in delay-100 drop-shadow-lg">Your online medical resource hub for students in Uganda.</p>
                            
                            <div class="mt-12 text-left w-full max-w-4xl bg-white bg-opacity-80 backdrop-blur-sm p-8 rounded-xl shadow-lg">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">What We Do</h2>
                                <p class="text-lg text-gray-700 leading-relaxed mb-4">
                                    Studypedia Uganda is a comprehensive online platform created to support medical students across Uganda. Our mission is to provide easy and centralized access to study materials, past papers, and valuable resources for various Diploma and Certificate courses. We understand the challenges students face in finding reliable and up-to-date content, and we aim to bridge that gap.
                                </p>
                                <p class="text-lg text-gray-700 leading-relaxed">
                                    By making educational materials readily available, we empower you to enhance your learning, prepare effectively for exams, and ultimately, excel in your medical studies. Explore our curated content by selecting your course below.
                                </p>
                            </div>
                            
                            <div class="flex flex-col md:flex-row gap-4 w-full justify-center mt-8">
                              ${user ? `<button id="courses-button" class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-xl hover:shadow-2xl hover:from-blue-700 hover:via-indigo-700 hover:to-purple-800 transform hover:scale-110 transition-all duration-500 ease-out animate-pulse">Browse Courses</button>` : ''}
                              <button id="about-button" class="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white font-bold py-3 px-6 rounded-full shadow-xl hover:shadow-2xl hover:from-purple-600 hover:via-pink-600 hover:to-red-600 transform hover:scale-110 transition-all duration-500 ease-out">About Us</button>
                              <button id="privacy-button" class="bg-gradient-to-r from-green-500 via-teal-500 to-cyan-500 text-white font-bold py-3 px-6 rounded-full shadow-xl hover:shadow-2xl hover:from-green-600 hover:via-teal-600 hover:to-cyan-600 transform hover:scale-110 transition-all duration-500 ease-out">Privacy Policy</button>
                            </div>

                            <!-- Welcome message for logged-in users -->
                            <div id="welcome-message" class="mt-8 text-center hidden">
                              <div class="bg-green-50 border border-green-200 rounded-lg p-4 inline-block">
                                <p class="text-green-800 font-semibold">Welcome back! Click "Browse Courses" to access your study materials.</p>
                              </div>
                            </div>
                            
                            
                        
                            <!-- Admin Access Button (only visible to admin) -->
                            <div id="admin-access-section" class="mt-12 text-center hidden">
                              <button id="admin-access-button" class="bg-gradient-to-r from-purple-600 via-indigo-600 to-purple-800 text-white font-bold py-4 px-8 rounded-full shadow-xl hover:shadow-2xl hover:from-purple-700 hover:via-indigo-700 hover:to-purple-900 transform hover:scale-110 transition-all duration-500 ease-out">
                                <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                Admin Dashboard
                              </button>
                            </div>

                            <!-- AdSense Banner Ad Space at Bottom of Home -->
                            <div id="home-ad-bottom" class="mt-12 text-center">
                                <div class="mx-auto w-full max-w-4xl h-16 bg-gray-200 rounded-lg"></div>
                            </div>
                        
                        </div>
                    `;
          break;
        case 'courses':
          contentHTML = `
            <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-4xl mx-auto">
              <!-- AdSense Rectangle Ad Space Above Courses -->
              <div id="courses-ad-top" class="mb-6 text-center">
                <div class="mx-auto w-full max-w-md h-32 bg-gray-200 rounded-lg"></div>
              </div>
              <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Available Courses</h2>
              <p class="text-gray-600 mb-6 text-center">Expand a course to view its semesters and explore courseunits and documents.</p>
              ${courses.length > 0 ? `
                <div class="space-y-4">
                  ${courses.map((course) => `
                    <div class="course-item-main bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl shadow-md overflow-hidden cursor-pointer border border-blue-200 hover:border-blue-300 transition-all duration-300 ease-in-out transform hover:scale-105" data-course-id="${course.id}">
                      <div class="select-course-main w-full text-left text-gray-800 py-6 px-4 font-semibold hover:bg-gradient-to-r hover:from-blue-200 hover:to-indigo-200 transition-all duration-300 ease-in-out cursor-pointer ${selectedCourse === course.id ? 'bg-gradient-to-r from-blue-100 to-indigo-100 ring-2 ring-blue-300' : ''}" data-course-id="${course.id}" style="user-select: none;">
                        ${course.name || 'Unknown Course'}
                      </div>
                      <div class="semesters-list-main bg-white hidden px-4 pb-4 space-y-2"></div>
                    </div>
                  `).join('')}
                </div>
              ` : `<div class="text-center py-8">
                ${renderLoading('Loading courses from database...')}
              </div>`}
              <!-- AdSense Rectangle Ad Space Below Courses -->
              <div id="courses-ad-bottom" class="mt-6 text-center">
                <div class="mx-auto w-full max-w-md h-32 bg-gray-200 rounded-lg"></div>
              </div>
            </div>
          `;
          break;
        case 'course-semesters':
          const selectedCourseData = courses.find(c => c.id === selectedCourse);
          contentHTML = `
                        <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-4xl mx-auto">
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">${selectedCourseData?.name || 'Unknown Course'}</h2>
                            ${semesters.length > 0 ? `
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                    ${semesters.map((semester, sIndex) => `
                                        <button class="select-semester bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 py-3 px-4 rounded-lg shadow-sm hover:from-blue-200 hover:to-indigo-200 hover:text-blue-700 transform hover:scale-105 transition-all duration-300 ease-in-out text-left border border-gray-300 hover:border-blue-300" data-semester-id="${semester.id}">
                                            ${semester.name || `Semester ${sIndex + 1}`}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : `<p class="text-center text-gray-500 py-8">No semesters found for this course.</p>`}
                        </div>
                    `;
          break;
        case 'semester-courseunits':
          const selectedSemesterData = semesters.find(s => s.id === selectedSemester);
          contentHTML = `
                        <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full">
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">${selectedSemesterData?.name || 'Unknown Semester'}</h2>
                            <p class="text-gray-600 mb-6">Select a course unit to view documents.</p>
                            ${courseUnits.length > 0 ? `
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                    ${courseUnits.map((courseUnit, uIndex) => `
                                        <button class="select-courseunit bg-gradient-to-r from-green-50 to-teal-100 text-gray-800 py-3 px-4 rounded-lg shadow-sm hover:from-green-100 hover:to-teal-200 hover:text-green-700 transform hover:scale-105 transition-all duration-300 ease-in-out text-left border border-green-200 hover:border-green-300" data-courseunit-id="${courseUnit.id}">
                                            ${courseUnit.name || `Course Unit ${uIndex + 1}`}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : `<p class="text-center text-gray-500 py-8">No course units available for this semester. Please contact support to add content.</p>`}
                        </div>
                    `;
          break;
        case 'document-viewer':
          const selectedCourseUnitData = courseUnits.find(u => u.id === selectedCourseUnit);
          contentHTML = `
              <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">${selectedCourseUnitData?.name || 'Unknown Course Unit'}</h2>
                <p class="text-gray-600 mb-6">Showing documents for ${courses.find(c => c.id === selectedCourse)?.name || 'Unknown Course'} - ${semesters.find(s => s.id === selectedSemester)?.name || 'Unknown Semester'} - ${selectedCourseUnitData?.name || 'Unknown Course Unit'}</p>
                ${documents.length > 0 ? `
                  <div class="space-y-4">
                    ${documents.map(doc => {
              const displayTitle = doc.title || doc.id || 'Untitled Document';
              if (!doc.filePath) {
                console.warn(`Document ${doc.id} is missing 'filePath' field. Buttons will not be shown. Add 'title' (string) and 'filePath' (URL or Storage path) in Firebase.`);
                return `
                        <div class="bg-white p-4 rounded-lg shadow-md text-center text-gray-500 border border-gray-300">
                          <span class="font-medium text-gray-700 mb-2 block">${displayTitle}</span>
                          <p class="text-sm">Missing file path. Update this document in Firebase with 'title' and 'filePath' fields to enable read/download.</p>
                        </div>
                      `;
              }
              const safeDoc = { ...doc, title: displayTitle };
              const jsonStr = JSON.stringify(safeDoc).replace(/"/g, '&quot;');
              return `
                      <div class="bg-gradient-to-br from-white to-blue-50 p-6 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-center transition-all duration-300 ease-in-out hover:shadow-xl hover:from-blue-50 hover:to-indigo-100 border border-blue-200 hover:border-blue-300">
                        <div class="text-center sm:text-left mb-2 sm:mb-0">
                          <span class="font-semibold text-gray-800 text-lg">${displayTitle}</span>
                          ${doc.description ? `<p class="text-sm text-gray-600 mt-1 italic">${doc.description}</p>` : ''}
                        </div>
                        <div class="flex flex-row space-x-3 mt-3 sm:mt-0">
                          <button class="view-doc bg-gradient-to-r from-green-500 to-emerald-600 text-white text-sm py-3 px-6 rounded-full hover:from-green-600 hover:to-emerald-700 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl" data-doc="${jsonStr}">
                            Read Online
                          </button>
                          <button class="download-doc bg-gradient-to-r from-blue-600 to-indigo-700 text-white text-sm py-3 px-6 rounded-full hover:from-blue-700 hover:to-indigo-800 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl" data-doc="${jsonStr}">
                            Download
                          </button>
                        </div>
                      </div>
                    `;
            }).join('')}
                  </div>
                ` : `<p class="text-center text-gray-500 py-8">No documents yet for this course unit in Certificate Medical Lab Science. Use the 'Seed CLT' button (visible when logged in) to add sample documents. Ensure each document in Firebase has 'title' (string) and 'filePath' (URL or Storage path) fields for read online and download buttons to work.</p>`}
              </div>
            `;
          break;
        case 'about':
          contentHTML = `
                        <div class="p-8 bg-gradient-to-br from-white via-blue-50 to-indigo-100 backdrop-blur-sm rounded-2xl shadow-2xl w-full border border-blue-200">
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-700 bg-clip-text text-transparent mb-6 animate-fade-in">About Studypedia Uganda</h2>
                            <p class="text-gray-700 mb-6 leading-relaxed text-lg">Studypedia Uganda is a dedicated platform for medical students, offering a centralized repository of study materials and resources to help them excel in their Diploma and Certificate courses. We are committed to providing easy access to quality educational content.</p>
                            <h3 class="text-3xl font-semibold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent mb-4">Contact Us</h3>
                            <ul class="space-y-3 text-gray-700">
                                <li>
                                    <a href="tel:+256756454646" class="flex items-center space-x-2 text-blue-500 hover:text-blue-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                        </svg>
                                        <span>+256 756 454 646</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="https://wa.me/256756454646" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 text-green-600 hover:text-green-800 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                        </svg>
                                        <span>+256 756 454 646</span>
                                    </a>
                                </li>
                                <li>
                                  <a href="https://t.me/256706571957" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 text-blue-400 hover:text-blue-600 transition-colors">
                                    <img src="https://telegram.org/img/t_logo.png" alt="Telegram" class="h-6 w-6">
                                    <span>+256 706 571 957</span>
                                  </a>
                                </li>
                                <li>
                                    <a href="mailto:kaigwaakram123@gmail.com" class="flex items-center space-x-2 text-red-500 hover:text-red-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                                        </svg>
                                        <span>kaigwaakram123@gmail.com</span>
                                    </a>
                                </li>
                            </ul>
                            <div class="mt-8 text-center">
                                <button class="back-home bg-gradient-to-r from-gray-300 to-gray-400 text-gray-800 py-3 px-8 rounded-full hover:from-gray-400 hover:to-gray-500 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl font-semibold">Back to Home</button>
                            </div>
                        </div>
                    `;
          break;
        case 'privacy':
          contentHTML = `
                        <div class="p-8 bg-gradient-to-br from-white via-green-50 to-teal-100 backdrop-blur-sm rounded-2xl shadow-2xl w-full border border-green-200">
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent mb-6 animate-fade-in">Privacy Policy</h2>
                            <p class="text-gray-700 mb-6 leading-relaxed text-lg">Your privacy is important to us. This policy outlines how Studypedia Uganda collects, uses, and protects your information. We do not share your personal data with third parties. All access and usage data is anonymized to improve our service. Your documents are stored securely with Firebase Firestore and Storage, with public documents accessible to all logged-in users and private documents restricted to the authenticated user's ID.</p>
                            <div class="mt-8 text-center">
                              <button class="back-home bg-gradient-to-r from-gray-300 to-gray-400 text-gray-800 py-3 px-8 rounded-full hover:from-gray-400 hover:to-gray-500 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-xl font-semibold">Back to Home</button>
                            </div>
                        </div>
                    `;
          break;
        case 'admin-dashboard':
          contentHTML = `
                        <div class="p-8 bg-gradient-to-br from-white via-purple-50 to-indigo-100 backdrop-blur-sm rounded-2xl shadow-2xl w-full border border-purple-200">
                            <div class="flex justify-between items-center mb-6">
                              <h2 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent animate-fade-in">Admin Dashboard</h2>
                              <button onclick="window.goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors">
                                Back to Home
                              </button>
                            </div>

                            <!-- Admin Stats Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                              <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-200">
                                <div class="flex items-center justify-between">
                                  <div>
                                    <p class="text-sm font-medium text-gray-600">Total Users</p>
                                    <p id="total-users" class="text-3xl font-bold text-purple-600">--</p>
                                  </div>
                                  <div class="bg-purple-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                    </svg>
                                  </div>
                                </div>
                              </div>

                              <div class="bg-white p-6 rounded-xl shadow-lg border border-green-200">
                                <div class="flex items-center justify-between">
                                  <div>
                                    <p class="text-sm font-medium text-gray-600">Approved Users</p>
                                    <p id="approved-users" class="text-3xl font-bold text-green-600">--</p>
                                  </div>
                                  <div class="bg-green-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                  </div>
                                </div>
                              </div>

                              <div class="bg-white p-6 rounded-xl shadow-lg border border-yellow-200">
                                <div class="flex items-center justify-between">
                                  <div>
                                    <p class="text-sm font-medium text-gray-600">Pending Users</p>
                                    <p id="pending-users" class="text-3xl font-bold text-yellow-600">--</p>
                                  </div>
                                  <div class="bg-yellow-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                  </div>
                                </div>
                              </div>

                              <div class="bg-white p-6 rounded-xl shadow-lg border border-red-200">
                                <div class="flex items-center justify-between">
                                  <div>
                                    <p class="text-sm font-medium text-gray-600">Rejected Users</p>
                                    <p id="rejected-users" class="text-3xl font-bold text-red-600">--</p>
                                  </div>
                                  <div class="bg-red-100 p-3 rounded-full">
                                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Search and Filter Section -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                              <div class="flex flex-col md:flex-row gap-4 items-center">
                                <div class="flex-1 w-full">
                                  <input type="text" id="user-search" placeholder="Search users by email..."
                                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div class="flex gap-2">
                                  <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                  </select>
                                  <button id="refresh-users" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors" onclick="window.loadAdminDashboard()">
                                    Refresh
                                  </button>
                                </div>
                              </div>
                            </div>

                            <!-- Bulk Actions -->
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                              <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                                <div class="flex items-center gap-4">
                                  <label class="flex items-center">
                                    <input type="checkbox" id="select-all-users" class="mr-2">
                                    <span class="text-sm font-medium">Select All</span>
                                  </label>
                                  <span id="selected-count" class="text-sm text-gray-600">0 selected</span>
                                </div>
                                <div class="flex gap-2">
                                  <button id="bulk-approve" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors hidden" onclick="window.bulkApproveUsers()">
                                    Approve Selected
                                  </button>
                                  <button id="bulk-reject" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors hidden" onclick="window.bulkRejectUsers()">
                                    Reject Selected
                                  </button>
                                </div>
                              </div>
                            </div>

                            <!-- Users Table -->
                            <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                              <div class="p-6 border-b border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-800">User Management</h3>
                              </div>
                              <div id="users-table" class="p-6">
                                <div class="text-center py-8">
                                  <div class="animate-spin rounded-full h-8 w-8 border-4 border-purple-500 border-t-transparent mx-auto"></div>
                                  <p class="mt-4 text-gray-500">Loading users...</p>
                                </div>
                              </div>
                            </div>
                        </div>
                    `;
          break;
      }
      mainContent.innerHTML = contentHTML;
    }

    // Fetching functions
    function fetchCourses() {
      courseList.innerHTML = `<li class="text-gray-500">Loading...</li>`;
      const coursesRef = collection(db, 'RESOURCES_STUDYPEDIA');
      onSnapshot(coursesRef, (querySnapshot) => {
        try {
          courses = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderCourseList();
          // Re-render main content if on courses page to handle async loading
          if (currentPage === 'courses') {
            renderContent();
          }
        } catch (error) {
          console.error("Error in courses onSnapshot:", error);
        }
      }, (error) => {
        console.error("Error fetching courses:", error);
        courseList.innerHTML = `<li class="text-red-500">Failed to load courses.</li>`;
        // Also re-render if error on courses page
        if (currentPage === 'courses') {
          renderContent();
        }
      });
    }

    function renderCourseList() {
      if (courses.length > 0) {
        courseList.innerHTML = courses.map(course => `
                    <li class="course-item" data-course-id="${course.id}">
                        <button class="select-course w-full text-left text-gray-600 hover:text-blue-600 hover:bg-gray-50 transition-colors py-2 px-3 rounded-lg cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 ${selectedCourse === course.id ? 'active-menu' : ''}" data-course-id="${course.id}">
                            ${course.name || 'Unknown Course'}
                        </button>
                        <ul class="semesters-list pl-4 space-y-1 hidden"></ul>
                    </li>
                `).join('');
      } else {
        courseList.innerHTML = `<li class="text-gray-500">No courses found.</li>`;
      }
    }

    function fetchSemesters() {
      if (!selectedCourse) {
        console.error('selectedCourse is undefined in fetchSemesters');
        mainContent.innerHTML = `<div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg"><p class="text-center text-red-500 py-8">Invalid course selection. Please try again.</p></div>`;
        return;
      }
      mainContent.innerHTML = renderLoading('Loading semesters...');
      const semestersRef = collection(db, `RESOURCES_STUDYPEDIA/${selectedCourse}/semesters`);
      onSnapshot(semestersRef, (querySnapshot) => {
        try {
          semesters = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          if (currentPage === 'course-semesters') {
            renderContent();
          }
        } catch (error) {
          console.error("Error in semesters onSnapshot:", error);
        }
      }, (error) => {
        console.error("Error fetching semesters:", error);
        mainContent.innerHTML = `<div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg"><p class="text-center text-red-500 py-8">Failed to load semesters. Please try again.</p></div>`;
      });
    }

    function fetchCourseUnits() {
      if (!selectedCourse || !selectedSemester) {
        console.error('selectedCourse or selectedSemester is undefined in fetchCourseUnits', { selectedCourse, selectedSemester });
        mainContent.innerHTML = `<div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg"><p class="text-center text-red-500 py-8">Invalid selection. Please go back and try again.</p></div>`;
        return;
      }
      mainContent.innerHTML = renderLoading('Loading course units...');
      const courseUnitsRef = collection(db, `RESOURCES_STUDYPEDIA/${selectedCourse}/semesters/${selectedSemester}/courseunits`);
      onSnapshot(courseUnitsRef, (querySnapshot) => {
        try {
          courseUnits = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          if (currentPage === 'semester-courseunits') {
            renderContent();
          }
        } catch (error) {
          console.error("Error in courseUnits onSnapshot:", error);
        }
      }, (error) => {
        console.error("Error fetching course units:", error);
        mainContent.innerHTML = `<div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg"><p class="text-center text-red-500 py-8">Failed to load course units. Please try again.</p></div>`;
      });
    }

    function fetchDocuments() {
      if (!selectedCourse || !selectedSemester || !selectedCourseUnit) {
        console.error('selectedCourse, selectedSemester, or selectedCourseUnit is undefined in fetchDocuments', { selectedCourse, selectedSemester, selectedCourseUnit });
        mainContent.innerHTML = `<div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg"><p class="text-center text-red-500 py-8">Invalid selection. Please go back and try again.</p></div>`;
        return;
      }
      mainContent.innerHTML = renderLoading('Loading documents...');
      const docsRef = collection(db, `RESOURCES_STUDYPEDIA/${selectedCourse}/semesters/${selectedSemester}/courseunits/${selectedCourseUnit}/documents`);
      onSnapshot(docsRef, (querySnapshot) => {
        try {
          documents = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          if (currentPage === 'document-viewer') {
            renderContent();
          }
        } catch (error) {
          console.error("Error in documents onSnapshot:", error);
        }
      }, (error) => {
        console.error("Error fetching documents:", error);
        mainContent.innerHTML = `<div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg"><p class="text-center text-red-500 py-8">Failed to load documents. Please try again.</p></div>`;
      });
    }

    // Function to add 5 documents to each existing course unit in Certificate Medical Lab Science semesters
    async function seedCLT10Units() {
      try {
        console.log('Starting to add 5 documents to each existing course unit in Certificate Medical Lab Science semesters...');
        const coursesRef = collection(db, 'RESOURCES_STUDYPEDIA');
        const coursesSnapshot = await getDocs(coursesRef);
        const cltCourses = coursesSnapshot.docs.filter((doc) => {
          const name = doc.data().name || '';
          const lowerName = name.toLowerCase();
          return lowerName.includes('certificate') && (lowerName.includes('medical lab') || lowerName.includes('lab science') || lowerName.includes('clt'));
        });

        if (cltCourses.length === 0) {
          alert('No Certificate Medical Lab Science course found. Please ensure the course exists in Firebase.');
          return;
        }

        const courseId = cltCourses[0].id;  // Assume first match
        console.log(`Found Certificate Medical Lab Science course ID: ${courseId} - ${cltCourses[0].data().name}`);

        const targetSemesters = ['CLT1:1', 'CLT1:2', 'CLT2:1', 'CLT2:2'];

        const sampleDocuments = [
          { title: 'Lab Safety Protocols', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Essential lab safety guidelines.' },
          { title: 'Microbiology Basics', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Introduction to microorganisms.' },
          { title: 'Hematology Notes', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Blood analysis techniques.' },
          { title: 'Clinical Chemistry Guide', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Chemical testing procedures.' },
          { title: 'Lab Equipment Manual', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Handling and maintenance of lab tools.' }
        ];

        let successfulSemesters = 0;
        let totalDocumentsAdded = 0;

        for (const semesterId of targetSemesters) {
          console.log(`\n--- Processing semester: ${semesterId} ---`);

          // Check if semester exists
          const semesterRef = doc(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters/${semesterId}`);
          const semesterSnap = await getDoc(semesterRef);
          if (!semesterSnap.exists()) {
            console.log(`Semester ${semesterId} does not exist. Skipping.`);
            continue;
          }

          // Get existing course units
          const unitsRef = collection(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters/${semesterId}/courseunits`);
          const unitsSnapshot = await getDocs(unitsRef);
          if (unitsSnapshot.empty) {
            console.log(`No course units found in semester ${semesterId}. Skipping.`);
            continue;
          }

          let documentsAddedThisSemester = 0;

          // For each existing unit, add 5 documents
          for (const unitDoc of unitsSnapshot.docs) {
            const unitId = unitDoc.id;
            const docsRef = collection(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters/${semesterId}/courseunits/${unitId}/documents`);

            // Add 5 new documents (always add, even if some exist, to ensure 5 more)
            for (let d = 0; d < 5; d++) {
              const docData = sampleDocuments[d];
              await addDoc(docsRef, docData);
            }
            documentsAddedThisSemester += 5;
            totalDocumentsAdded += 5;
            console.log(`Added 5 documents to unit ${unitId} in semester ${semesterId}`);
          }

          console.log(`Added ${documentsAddedThisSemester} documents to ${unitsSnapshot.size} units in semester ${semesterId}`);
          successfulSemesters++;
        }

        console.log(`\nDocument seeding completed: ${successfulSemesters} semesters updated with ${totalDocumentsAdded} documents added.`);
        alert(`Document seeding successful! Added 5 documents to each existing course unit in ${successfulSemesters} Certificate Medical Lab Science semesters (with read online and download buttons). The page will refresh to show them.`);

        // Optionally hide button after success
        if (seedButton) {
          seedButton.style.display = 'none';
        }

        // Refresh to update the UI with new data (disabled to prevent reload loops)
        console.log('Would reload for CLT seeding, but disabled to prevent loops');

      } catch (error) {
        console.error('Error during Certificate Medical Lab Science document seeding:', error);
        alert(`Seeding failed: ${error.message}. Please check the console for details and ensure you have write permissions in Firestore.`);
      }
    }


        // Function to seed 9 course units for Certificate in Medical Lab Science semesters (one-time only, clears existing, no creation)
        async function seedDCM31Units() {
          // Temporarily remove localStorage check to force re-seeding
          // localStorage.removeItem('cml_all_seeded');

          try {
            console.log('Starting one-time seeding for all Certificate in Medical Lab Science semesters with 9 units each...');

            const coursesRef = collection(db, 'RESOURCES_STUDYPEDIA');
            const coursesSnapshot = await getDocs(coursesRef);

            // Define only CLT course and its semesters - no creation, only seed if found
            const courseConfig = {
              filter: (doc) => doc.data().name && doc.data().name.toLowerCase().includes('certificate') &&
                (doc.data().name.toLowerCase().includes('medical lab') || doc.data().name.toLowerCase().includes('lab science') || doc.data().name.toLowerCase().includes('clt')),
              name: 'Certificate in Medical Lab Science',
              prefix: 'CLT',
              semesters: ['CLT1:1', 'CLT1:2', 'CLT2:1', 'CLT2:2']
            };

            let courseDocs = coursesSnapshot.docs.filter(courseConfig.filter);

            if (courseDocs.length === 0) {
              console.log(`No ${courseConfig.name} course found. Skipping.`);
              alert('No Certificate in Medical Lab Science course found. Please create it first.');
              return false;
            }

            const courseId = courseDocs[0].id;
            console.log(`Using ${courseConfig.name} course for seeding: ${courseId}`);
            let seededCourses = 1;

            // 9 sample units (tailored for lab science)
            const sampleUnits = [
              { name: 'Basic Laboratory Sciences', description: 'Foundational lab knowledge.' },
              { name: 'Microbiology Techniques', description: 'Microbial identification skills.' },
              { name: 'Hematology', description: 'Blood analysis fundamentals.' },
              { name: 'Clinical Chemistry', description: 'Chemical testing methods.' },
              { name: 'Immunology', description: 'Immune system lab procedures.' },
              { name: 'Urinalysis and Body Fluids', description: 'Fluid analysis techniques.' },
              { name: 'Lab Safety and Quality Control', description: 'Safety protocols and standards.' },
              { name: 'Instrumentation', description: 'Lab equipment operation.' },
              { name: 'Phlebotomy and Specimen Collection', description: 'Sample handling practices.' }
            ];

            // 5 sample documents per unit
            const sampleDocuments = [
              { title: 'Lab Lecture Notes', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Core lab material.' },
              { title: 'Practical Exercises', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Hands-on lab activities.' },
              { title: 'Past Lab Exams', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Previous assessments.' },
              { title: 'Safety Guidelines', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Protocol summaries.' },
              { title: 'Case Studies in Diagnostics', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Real lab scenarios.' }
            ];

            // For each semester in this course
            for (const semesterId of courseConfig.semesters) {
              console.log(`Processing semester ${semesterId} for ${courseConfig.name}...`);

              // Check if semester exists
              const semesterDocRef = doc(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters`, semesterId);
              const semesterDocSnap = await getDoc(semesterDocRef);
              if (!semesterDocSnap.exists()) {
                console.log(`Semester ${semesterId} not found in ${courseConfig.name}. Skipping.`);
                continue;
              }

              // Clear all existing units in this semester
              const unitsRef = collection(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters/${semesterId}/courseunits`);
              const existingUnitsSnapshot = await getDocs(unitsRef);
              if (existingUnitsSnapshot.size > 0) {
                const deleteBatch = writeBatch(db);
                for (const doc of existingUnitsSnapshot.docs) {
                  const unitDocsRef = collection(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters/${semesterId}/courseunits/${doc.id}/documents`);
                  const unitDocsSnapshot = await getDocs(unitDocsRef);
                  unitDocsSnapshot.docs.forEach((docSnap) => {
                    deleteBatch.delete(docSnap.ref);
                  });
                  deleteBatch.delete(doc.ref);
                }
                await deleteBatch.commit();
                console.log(`Cleared ${existingUnitsSnapshot.size} units and documents in ${semesterId}`);
              }

              // Seed 9 units for this semester
              for (let u = 0; u < 9; u++) {
                const unitId = `unit${u + 1}`;
                const unitDocRef = doc(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters/${semesterId}/courseunits`, unitId);
                await setDoc(unitDocRef, sampleUnits[u % sampleUnits.length], { merge: false });
                console.log(`Added unit ${sampleUnits[u % sampleUnits.length].name} to ${semesterId}`);

                const docsRef = collection(db, `RESOURCES_STUDYPEDIA/${courseId}/semesters/${semesterId}/courseunits/${unitId}/documents`);
                for (const docData of sampleDocuments) {
                  await addDoc(docsRef, docData);
                }
                console.log(`Added 5 documents to unit ${unitId} in ${semesterId}`);
              }
            }

            // Mark as seeded (commented to allow re-run if needed)
            // localStorage.setItem('cml_all_seeded', 'true');
            console.log('Certificate in Medical Lab Science all semesters seeding completed successfully (one-time).');
            alert(`Successfully seeded 9 course units with 5 documents each for all existing semesters in ${courseConfig.name}! Refresh to see changes.`);
            return true;
          } catch (error) {
            console.error('Certificate in Medical Lab Science seeding error:', error);
            alert(`Seeding failed: ${error.message}. Check console for details.`);
            return false;
          }
        }

    // Function to seed 5 diploma courses with 6 semesters, 10 course units each, and 10 documents per unit
    async function seedDiplomaCourses() {
      try {
        console.log('Starting to seed 5 diploma courses with complete structure...');

        const diplomaCourses = [
          {
            name: 'Diploma in Clinical Medicine and Community Health',
            code: 'DCM',
            semesters: ['DCM1:1', 'DCM1:2', 'DCM2:1', 'DCM2:2', 'DCM3:1', 'DCM3:2']
          },
          {
            name: 'Diploma in Nursing',
            code: 'NURS',
            semesters: ['NURS1:1', 'NURS1:2', 'NURS2:1', 'NURS2:2', 'NURS3:1', 'NURS3:2']
          },
          {
            name: 'Diploma in Pharmacy',
            code: 'DPHA',
            semesters: ['DPHA1:1', 'DPHA1:2', 'DPHA2:1', 'DPHA2:2', 'DPHA3:1', 'DPHA3:2']
          },
          {
            name: 'Diploma in Medical Laboratory Technology',
            code: 'DMLT',
            semesters: ['DMLT1:1', 'DMLT1:2', 'DMLT2:1', 'DMLT2:2', 'DMLT3:1', 'DMLT3:2']
          },
          {
            name: 'Diploma in Dental Technology',
            code: 'DDT',
            semesters: ['DDT1:1', 'DDT1:2', 'DDT2:1', 'DDT2:2', 'DDT3:1', 'DDT3:2']
          }
        ];

        const courseUnits = [
          'Anatomy and Physiology',
          'Pathology',
          'Pharmacology',
          'Microbiology',
          'Clinical Skills',
          'Medical Ethics',
          'Community Health',
          'Research Methods',
          'Health Management',
          'Emergency Medicine'
        ];

        const sampleDocuments = [
          { title: 'Lecture Notes Chapter 1', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Comprehensive lecture notes' },
          { title: 'Practical Manual', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Hands-on practice guide' },
          { title: 'Past Paper 2023', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Previous examination paper' },
          { title: 'Study Guide', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Study preparation material' },
          { title: 'Case Studies', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Real clinical scenarios' },
          { title: 'Lab Protocols', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Laboratory procedures' },
          { title: 'Clinical Guidelines', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Clinical practice guidelines' },
          { title: 'Assessment Guide', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Assessment and evaluation guide' },
          { title: 'Reference Material', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Additional reference resources' },
          { title: 'Practice Questions', filePath: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', description: 'Practice questions and answers' }
        ];

        let totalCoursesCreated = 0;
        let totalSemestersCreated = 0;
        let totalUnitsCreated = 0;
        let totalDocumentsCreated = 0;

        for (const course of diplomaCourses) {
          console.log(`\n--- Creating course: ${course.name} ---`);

          // Create course
          const courseRef = collection(db, 'RESOURCES_STUDYPEDIA');
          const courseDoc = await addDoc(courseRef, {
            name: course.name,
            code: course.code,
            description: `${course.name} - Complete diploma program with 6 semesters`
          });
          totalCoursesCreated++;

          // Create semesters for this course
          for (const semesterId of course.semesters) {
            console.log(`Creating semester: ${semesterId}`);

            const semesterRef = doc(db, `RESOURCES_STUDYPEDIA/${courseDoc.id}/semesters`, semesterId);
            await setDoc(semesterRef, {
              name: semesterId,
              description: `${semesterId} - Semester with 10 course units`
            });
            totalSemestersCreated++;

            // Create 10 course units for this semester
            for (let i = 0; i < 10; i++) {
              const unitId = `unit${i + 1}`;
              const unitRef = doc(db, `RESOURCES_STUDYPEDIA/${courseDoc.id}/semesters/${semesterId}/courseunits`, unitId);
              await setDoc(unitRef, {
                name: courseUnits[i],
                description: `${courseUnits[i]} - Comprehensive course unit`
              });
              totalUnitsCreated++;

              // Create 10 documents for this course unit
              const docsRef = collection(db, `RESOURCES_STUDYPEDIA/${courseDoc.id}/semesters/${semesterId}/courseunits/${unitId}/documents`);
              for (let j = 0; j < 10; j++) {
                await addDoc(docsRef, sampleDocuments[j]);
                totalDocumentsCreated++;
              }
              console.log(`Created unit ${unitId} with 10 documents`);
            }
          }
        }

        console.log(`\nDiploma seeding completed successfully!`);
        console.log(`- Courses created: ${totalCoursesCreated}`);
        console.log(`- Semesters created: ${totalSemestersCreated}`);
        console.log(`- Course units created: ${totalUnitsCreated}`);
        console.log(`- Documents created: ${totalDocumentsCreated}`);

        alert(`Diploma seeding completed successfully!\n\nCreated 5 diploma courses with:\n‚Ä¢ 6 semesters each\n‚Ä¢ 10 course units per semester\n‚Ä¢ 10 documents per course unit\n\nTotal: ${totalDocumentsCreated} documents with read online and download functionality.\n\nRefresh the page to see all new courses!`);

        // Hide the seed button after successful completion
        const seedDiplomaButton = document.getElementById('seed-diploma-button');
        if (seedDiplomaButton) {
          seedDiplomaButton.classList.add('hidden');
        }

        // Refresh to show new data (disabled to prevent reload loops)
        console.log('Would reload for diploma seeding, but disabled to prevent loops');

      } catch (error) {
        console.error('Error during diploma course seeding:', error);
        alert(`Seeding failed: ${error.message}. Please check the console for details and ensure you have write permissions in Firestore.`);
      }
    }

    // Admin panel functions
    function showAdminPanel() {
      // Add admin panel to the sidebar
      const userProfileSection = document.getElementById('user-profile-section');
      if (userProfileSection && user.email === 'kaigwaakram123@gmail.com') {
        userProfileSection.innerHTML = `
          <div class="flex items-center space-x-2 mb-2">
            <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            <span>Admin Panel</span>
          </div>
          <button id="view-pending-payments" class="w-full bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded mb-2 transition-colors">
            Pending Payments (${getPendingPaymentsCount()})
          </button>
          <button id="view-approved-payments" class="w-full bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded transition-colors">
            Approved Users
          </button>
        `;
      }
    }

    function showAdminAccessButton() {
      // Show admin dashboard button in sidebar
      const adminButton = document.getElementById('admin-dashboard-button');
      if (adminButton) {
        adminButton.classList.remove('hidden');
      }

      // Show admin access button on homepage
      const adminAccessSection = document.getElementById('admin-access-section');
      const adminAccessButton = document.getElementById('admin-access-button');
      if (adminAccessSection && adminAccessButton) {
        adminAccessSection.classList.remove('hidden');
      }
    }

    // Admin Dashboard Functions - Global variables
    let allUsers = [];
    let filteredUsers = [];
    let selectedUsers = new Set();

    async function loadAdminDashboard() {
      try {
        console.log('Loading admin dashboard...');
        const paymentsSnapshot = await getDocs(collection(db, 'user_payments'));
        const users = [];
        const stats = { total: 0, approved: 0, pending: 0, rejected: 0 };

        paymentsSnapshot.forEach(doc => {
          const data = doc.data();
          users.push({
            id: doc.id,
            email: data.userEmail,
            status: data.status,
            amount: data.amount,
            paymentMethod: data.paymentMethod,
            paymentReference: data.paymentReference,
            paymentDate: data.paymentDate,
            submittedAt: data.submittedAt,
            approvedAt: data.approvedAt,
            rejectedAt: data.rejectedAt,
            registeredAt: data.registeredAt,
            approvedBy: data.approvedBy,
            rejectedBy: data.rejectedBy
          });
          stats.total++;
          if (data.status === 'approved') stats.approved++;
          else if (data.status === 'pending') stats.pending++;
          else if (data.status === 'rejected') stats.rejected++;
        });

        allUsers = users;
        filteredUsers = users;

        // Update stats
        document.getElementById('total-users').textContent = stats.total;
        document.getElementById('approved-users').textContent = stats.approved;
        document.getElementById('pending-users').textContent = stats.pending;
        document.getElementById('rejected-users').textContent = stats.rejected;

        renderUsersTable();
        // Setup event listeners after a short delay to ensure DOM is ready
        setTimeout(() => {
          setupAdminDashboardEventListeners();
        }, 100);

      } catch (error) {
        console.error('Error loading admin dashboard:', error);
        document.getElementById('users-table').innerHTML = `
          <div class="text-center py-8">
            <p class="text-red-500">Error loading users: ${error.message}</p>
          </div>
        `;
      }
    }

    function renderUsersTable() {
      const tableContainer = document.getElementById('users-table');
      if (filteredUsers.length === 0) {
        tableContainer.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-500">No users found.</p>
          </div>
        `;
        return;
      }

      const usersHtml = filteredUsers.map(user => {
        const date = user.paymentDate ? new Date(user.paymentDate.toDate()).toLocaleDateString() : 'N/A';
        const statusBadge = getStatusBadge(user.status);
        const isChecked = selectedUsers.has(user.id) ? 'checked' : '';

        return `
          <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
            <div class="flex items-start justify-between">
              <div class="flex items-start space-x-3">
                <input type="checkbox" class="user-checkbox mt-1" data-user-id="${user.id}" ${isChecked}>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <p class="font-semibold text-gray-800">${user.email}</p>
                    ${statusBadge}
                  </div>
                  <div class="text-sm text-gray-600 space-y-1">
                    <p>Amount: UGX ${user.amount?.toLocaleString() || 'N/A'}</p>
                    <p>Method: ${user.paymentMethod || 'N/A'}</p>
                    <p>Reference: ${user.paymentReference || 'N/A'}</p>
                    <p>Date: ${date}</p>
                  </div>
                </div>
              </div>
              <div class="flex gap-2">
                ${user.status === 'pending' ? `
                  <button onclick="window.approveSingleUser('${user.id}')"
                          class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors">
                    Approve
                  </button>
                  <button onclick="window.rejectSingleUser('${user.id}')"
                          class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                    Reject
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      tableContainer.innerHTML = usersHtml;
    }

    function getStatusBadge(status) {
      const badges = {
        'approved': '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">APPROVED</span>',
        'pending': '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">PENDING</span>',
        'rejected': '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">REJECTED</span>'
      };
      return badges[status] || '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-semibold">UNKNOWN</span>';
    }

    function setupAdminDashboardEventListeners() {
      // Search functionality
      const searchInput = document.getElementById('user-search');
      const statusFilter = document.getElementById('status-filter');
      const refreshButton = document.getElementById('refresh-users');
      const selectAllCheckbox = document.getElementById('select-all-users');
      const bulkApproveBtn = document.getElementById('bulk-approve');
      const bulkRejectBtn = document.getElementById('bulk-reject');

      if (searchInput) searchInput.addEventListener('input', filterUsers);
      if (statusFilter) statusFilter.addEventListener('change', filterUsers);
      if (refreshButton) refreshButton.addEventListener('click', () => loadAdminDashboard());

      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.user-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            const userId = checkbox.dataset.userId;
            if (this.checked) {
              selectedUsers.add(userId);
            } else {
              selectedUsers.delete(userId);
            }
          });
          updateBulkActions();
        });
      }

      // Setup checkbox event listeners after table is rendered
      setTimeout(() => {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const userId = this.dataset.userId;
            if (this.checked) {
              selectedUsers.add(userId);
            } else {
              selectedUsers.delete(userId);
            }
            updateBulkActions();
          });
        });
      }, 200);
    }

    function filterUsers() {
      const searchTerm = document.getElementById('user-search').value.toLowerCase();
      const statusFilter = document.getElementById('status-filter').value;

      filteredUsers = allUsers.filter(user => {
        const matchesSearch = user.email.toLowerCase().includes(searchTerm);
        const matchesStatus = statusFilter === 'all' || user.status === statusFilter;
        return matchesSearch && matchesStatus;
      });

      renderUsersTable();
    }

    function updateBulkActions() {
      const selectedCount = document.getElementById('selected-count');
      const bulkApproveBtn = document.getElementById('bulk-approve');
      const bulkRejectBtn = document.getElementById('bulk-reject');

      selectedCount.textContent = `${selectedUsers.size} selected`;

      if (selectedUsers.size > 0) {
        bulkApproveBtn.classList.remove('hidden');
        bulkRejectBtn.classList.remove('hidden');
      } else {
        bulkApproveBtn.classList.add('hidden');
        bulkRejectBtn.classList.add('hidden');
      }
    }

    async function approveSingleUser(userId) {
      if (confirm('Are you sure you want to approve this user?')) {
        await approveUserPayment(userId);
        await loadAdminDashboard(); // Refresh the dashboard
      }
    }

    async function rejectSingleUser(userId) {
      if (confirm('Are you sure you want to reject this user?')) {
        await rejectUserPayment(userId);
        await loadAdminDashboard(); // Refresh the dashboard
      }
    }

    // Make functions globally available
    window.bulkApproveUsers = bulkApproveUsers;
    window.bulkRejectUsers = bulkRejectUsers;
    window.approveSingleUser = approveSingleUser;
    window.rejectSingleUser = rejectSingleUser;
    window.loadAdminDashboard = loadAdminDashboard;

    async function bulkApproveUsers() {
      if (selectedUsers.size === 0) return;

      if (confirm(`Are you sure you want to approve ${selectedUsers.size} selected users?`)) {
        const promises = Array.from(selectedUsers).map(userId => approveUserPayment(userId));
        await Promise.all(promises);
        selectedUsers.clear();
        updateBulkActions();
        await loadAdminDashboard(); // Refresh the dashboard
      }
    }

    async function bulkRejectUsers() {
      if (selectedUsers.size === 0) return;

      if (confirm(`Are you sure you want to reject ${selectedUsers.size} selected users?`)) {
        const promises = Array.from(selectedUsers).map(userId => rejectUserPayment(userId));
        await Promise.all(promises);
        selectedUsers.clear();
        updateBulkActions();
        await loadAdminDashboard(); // Refresh the dashboard
      }
    }

    function getPendingPaymentsCount() {
      // This would be updated with real-time listener
      return '0';
    }

    // Approve user payment
    async function approveUserPayment(userId) {
      try {
        console.log('Approving payment for user:', userId);

        // Update payment status
        await setDoc(doc(db, 'user_payments', userId), {
          status: 'approved',
          approvedAt: new Date(),
          approvedBy: user.email
        }, { merge: true });
        console.log('Payment status updated to approved');

        // Add notification
        await addDoc(collection(db, 'payment_notifications'), {
          userId: userId,
          type: 'payment_approved',
          message: 'Your payment has been approved. You now have access to all courses.',
          createdAt: new Date()
        });
        console.log('Approval notification created');

        alert('Payment approved successfully!');
        loadPendingPayments(); // Refresh the list
      } catch (error) {
        console.error('Error approving payment:', error);
        alert('Error approving payment: ' + error.message);
      }
    }

    // Load pending payments for admin
    async function loadPendingPayments() {
      try {
        const paymentsSnapshot = await getDocs(query(
          collection(db, 'user_payments'),
          where('status', '==', 'pending')
        ));

        const pendingPayments = [];
        paymentsSnapshot.forEach(doc => {
          pendingPayments.push({ id: doc.id, ...doc.data() });
        });

        // Update the pending payments count
        const countElement = document.querySelector('#view-pending-payments');
        if (countElement) {
          countElement.textContent = `Pending Payments (${pendingPayments.length})`;
        }

        return pendingPayments;
      } catch (error) {
        console.error('Error loading pending payments:', error);
        return [];
      }
    }

    // Handle payment form submission
    async function handlePaymentSubmission(event) {
      event.preventDefault();

      const reference = document.getElementById('payment-reference').value.trim();
      const method = document.getElementById('payment-method').value;

      if (!reference || !method) {
        alert('Please fill in all payment details.');
        return;
      }

      try {
        await submitPaymentDetails(reference, method);
        alert('Payment details submitted successfully! Waiting for admin approval. You can continue browsing courses while waiting.');

        // Hide payment modal
        hidePaymentModal();

        // Show waiting message
        mainContent.innerHTML = `
          <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Payment Submitted Successfully!</h2>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
              <p class="text-gray-700">Your payment details have been submitted to admin and are waiting for approval.</p>
              <p class="text-sm text-gray-600 mt-2">You will be notified once approved. Thank you!</p>
            </div>
            <button onclick="goToPage('home')" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors">
              Back to Homepage
            </button>
          </div>
        `;

      } catch (error) {
        console.error('Error submitting payment:', error);
        alert('Error submitting payment: ' + error.message);
      }
    }

    // Admin panel functions
    async function showPendingPaymentsPanel() {
      try {
        const pendingPayments = await loadPendingPayments();

        let contentHTML = `
          <div class="p-8 bg-white bg-opacity-90 backdrop-blur-sm rounded-xl shadow-lg w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Pending Payments</h2>
            <div class="mb-4">
              <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                Back to Home
              </button>
            </div>
        `;

        if (pendingPayments.length === 0) {
          contentHTML += `
            <p class="text-center text-gray-500 py-8">No pending payments.</p>
          `;
        } else {
          contentHTML += `
            <div class="space-y-4">
              ${pendingPayments.map(payment => `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <p class="font-semibold text-gray-800">${payment.userEmail}</p>
                      <p class="text-sm text-gray-600">Amount: UGX ${payment.amount.toLocaleString()}</p>
                      <p class="text-sm text-gray-600">Method: ${payment.paymentMethod}</p>
                      <p class="text-sm text-gray-600">Reference: ${payment.paymentReference}</p>
                      <p class="text-sm text-gray-600">Date: ${new Date(payment.paymentDate.toDate()).toLocaleDateString()}</p>
                    </div>
                    <div class="flex space-x-2">
                      <button onclick="approveUserPayment('${payment.userId}')"
                              class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors">
                        Approve
                      </button>
                      <button onclick="rejectUserPayment('${payment.userId}')"
                              class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                        Reject
                      </button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        contentHTML += `</div>`;
        mainContent.innerHTML = contentHTML;

      } catch (error) {
        console.error('Error showing pending payments:', error);
        alert('Error loading pending payments: ' + error.message);
      }
    }

    async function showApprovedPaymentsPanel() {
      try {
        const approvedSnapshot = await getDocs(query(
          collection(db, 'user_payments'),
          where('status', '==', 'approved')
        ));

        const approvedPayments = [];
        approvedSnapshot.forEach(doc => {
          approvedPayments.push({ id: doc.id, ...doc.data() });
        });

        let contentHTML = `
          <div class="p-8 bg-white bg-opacity-90 backdrop-blur-sm rounded-xl shadow-lg w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Approved Users</h2>
            <div class="mb-4">
              <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                Back to Home
              </button>
            </div>
        `;

        if (approvedPayments.length === 0) {
          contentHTML += `
            <p class="text-center text-gray-500 py-8">No approved users yet.</p>
          `;
        } else {
          contentHTML += `
            <div class="space-y-4">
              ${approvedPayments.map(payment => `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="font-semibold text-gray-800">${payment.userEmail}</p>
                      <p class="text-sm text-gray-600">Amount: UGX ${payment.amount.toLocaleString()}</p>
                      <p class="text-sm text-gray-600">Approved: ${new Date(payment.approvedAt.toDate()).toLocaleDateString()}</p>
                    </div>
                    <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">
                      APPROVED
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        contentHTML += `</div>`;
        mainContent.innerHTML = contentHTML;

      } catch (error) {
        console.error('Error showing approved payments:', error);
        alert('Error loading approved payments: ' + error.message);
      }
    }

    // Reject user payment
    async function rejectUserPayment(userId) {
      try {
        // Update payment status
        await setDoc(doc(db, 'user_payments', userId), {
          status: 'rejected',
          rejectedAt: new Date(),
          rejectedBy: user.email
        }, { merge: true });

        // Add notification
        await addDoc(collection(db, 'payment_notifications'), {
          userId: userId,
          type: 'payment_rejected',
          message: 'Your payment has been rejected. Please contact admin for assistance.',
          createdAt: new Date()
        });

        alert('Payment rejected.');
        loadPendingPayments(); // Refresh the list
      } catch (error) {
        console.error('Error rejecting payment:', error);
        alert('Error rejecting payment: ' + error.message);
      }
    }

    // Initialize App on load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Starting Studypedia Uganda application...');
      try {
        console.log('üîß Initializing Firebase...');
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug');
        console.log('‚úÖ Firebase initialized successfully');

        onAuthStateChanged(auth, async (currentUser) => {
          authStateChangeCount++;
          console.log(`üîÑ Auth state changed #${authStateChangeCount}:`, currentUser ? "User logged in" : "No user");

          // Prevent multiple rapid auth state changes
          if (loginInProgress && currentUser) {
            console.log('‚ö†Ô∏è Login already in progress, ignoring duplicate auth state change');
            return;
          }

          user = currentUser;
          if (user) {
            loginInProgress = true;
            console.log("‚úÖ User authenticated:", user.uid);
            updateUserInfo();
            updateAuthUI(!user.isAnonymous, user);

            // Set up real-time listener for payment status with proper reload prevention
            if (!user.isAnonymous) {
              const paymentDocRef = doc(db, 'user_payments', user.uid);
              onSnapshot(paymentDocRef, (doc) => {
                if (doc.exists()) {
                  const paymentData = doc.data();
                  // FIX: Check both sessionStorage flag and payment status to prevent reload loops
                  if (paymentData.status === 'approved' && !hasReloadedForApproval) {
                    console.log('Payment approved, setting reload flag and reloading once...');
                    // Set the flag in sessionStorage BEFORE reloading
                    sessionStorage.setItem(reloadKey, 'true');
                    hasReloadedForApproval = true;
                    location.reload();
                  }
                }
              });
            }

            // Check if user is admin
            if (user.email === 'kaigwaakram123@gmail.com') {
              showAdminPanel();
              // Show admin dashboard button
              const adminButton = document.getElementById('admin-dashboard-button');
              if (adminButton) {
                adminButton.classList.remove('hidden');
              }
              // Show admin access button on homepage
              showAdminAccessButton();
              fetchCourses(); // Admin has full access
            } else if (user.isAnonymous) {
              // Anonymous users have limited access
              console.log('üë§ Anonymous user detected');
              fetchCourses();
            } else {
              // Check payment status for regular users
              console.log('üí≥ Checking payment status for regular user:', user.email);
              const paymentStatus = await checkPaymentStatus(user.uid);
              console.log('üí≥ Payment status result:', paymentStatus);

              if (paymentStatus.hasPaid || paymentStatus.status === 'none') {
                // Existing user with approved payment or no payment record (legacy user)
                console.log('‚úÖ User has access, fetching courses');
                loginInProgress = false;
                fetchCourses();
              } else if (paymentStatus.isNewUser) {
                // New user who needs to pay
                console.log('üÜï New user detected, showing payment modal in 1s');
                setTimeout(() => {
                  showPaymentModal();
                  loginInProgress = false;
                }, 1000);
              } else {
                // User with pending payment
                console.log('‚è≥ User has pending payment, showing payment modal in 1s');
                setTimeout(() => {
                  showPaymentModal();
                  loginInProgress = false;
                }, 1000);
              }
            }

          } else {
            loginInProgress = false;
            updateUserInfo();
            updateAuthUI(false, null);
            try {
              console.log("üë§ No user found. Signing in anonymously...");
              await signInAnonymously(auth);
            } catch (error) {
              console.error("‚ùå Firebase auth error:", error);
            }
          }
        });

        // Initialize with basic content first
        renderContent();
        console.log('üì± Initial content rendered');

        // Try to initialize Firebase
        try {
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          setLogLevel('debug');
          console.log('‚úÖ Firebase initialized successfully');

          // Initialize Firebase-dependent features
          cycleBgImages();
          console.log('üé® Background image cycling started');
        } catch (firebaseError) {
          console.error('‚ùå Firebase initialization failed:', firebaseError);
          console.log('üìù Continuing with basic functionality without Firebase');
        }

        // Enhanced back button event listeners
        const backButton = document.getElementById('back-button');
        
        // Mouse events
        backButton.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Add visual feedback
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = '';
          }, 150);
          
          // Handle navigation
          handleBack();
        });

        // Touch events for mobile devices
        backButton.addEventListener('touchstart', function(e) {
          this.style.transform = 'scale(0.95)';
        });

        backButton.addEventListener('touchend', function(e) {
          this.style.transform = '';
          handleBack();
        });

        // Single event delegation for all other elements (static and dynamic)
        document.addEventListener('click', async (e) => {
          if (e.target.id === 'courses-button') {
            e.preventDefault();
            // Check user permissions before allowing course access
            if (user && user.email === 'kaigwaakram123@gmail.com') {
              goToPage('courses', false); // Admin has full access
              console.log('Courses button clicked - admin access granted');
            } else if (user && !user.isAnonymous) {
              // Check payment status for regular users - BLOCK unapproved users
              checkPaymentStatus(user.uid).then(paymentStatus => {
                if (paymentStatus.hasPaid || paymentStatus.status === 'none') {
                  goToPage('courses', false); // User has approved payment or legacy access
                  console.log('Courses button clicked - approved user access granted');
                } else {
                  // User has pending payment - BLOCK access completely
                  mainContent.innerHTML = `
                    <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                      <h2 class="text-2xl font-bold text-gray-800 mb-4">‚õî Access Denied</h2>
                      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <p class="text-gray-700 font-semibold">You must wait for admin approval before accessing courses.</p>
                        <p class="text-sm text-gray-600 mt-2">Your payment is being reviewed. Access will be granted once approved.</p>
                      </div>
                      <button onclick="showPaymentModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors mr-2">
                        View Payment Details
                      </button>
                      <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                        Return to Homepage
                      </button>
                    </div>
                  `;
                  console.log('üö´ Courses button blocked for unapproved user');
                }
              }).catch(error => {
                console.error('Error checking payment status:', error);
                alert('Error verifying access permissions. Please contact admin.');
              });
            } else {
              // Anonymous users can browse course listings only
              goToPage('courses', false);
              console.log('Courses button clicked - anonymous user access granted');
            }
          } else if (e.target.id === 'about-button') {
            e.preventDefault();
            goToPage('about', false);
            console.log('About button clicked');
          } else if (e.target.id === 'privacy-button') {
            e.preventDefault();
            goToPage('privacy', false);
            console.log('Privacy button clicked');
          } else if (e.target.id === 'menu-button') {
            e.preventDefault();
            toggleMenu();
          } else if (e.target.id === 'close-menu-button') {
            toggleMenu();
          } else if (e.target.id === 'menu-overlay') {
            toggleMenu();
          } else if (e.target.id === 'home-button') {
            e.preventDefault();
            goToPage('home');
          } else if (e.target.id === 'about-nav-button') {
            e.preventDefault();
            goToPage('about', true); // Keep menu open for sidebar nav
          } else if (e.target.id === 'privacy-nav-button') {
            e.preventDefault();
            goToPage('privacy', true); // Keep menu open for sidebar nav
          } else {
            const courseBtn = e.target.closest('.select-course');
            if (courseBtn) {
              e.preventDefault();
              // Check if user has permission to access course content
              if (user && user.email === 'kaigwaakram123@gmail.com') {
                handleCourseSelection(courseBtn.dataset.courseId); // Admin has full access
              } else if (user && !user.isAnonymous) {
                // Check payment status for regular users - BLOCK unapproved users
                checkPaymentStatus(user.uid).then(paymentStatus => {
                  if (paymentStatus.hasPaid || paymentStatus.status === 'none') {
                    handleCourseSelection(courseBtn.dataset.courseId); // User has approved payment or legacy access
                  } else {
                    // User has pending payment - BLOCK access completely
                    mainContent.innerHTML = `
                      <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">‚õî Access Denied</h2>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                          <p class="text-gray-700 font-semibold">You must wait for admin approval before accessing course content.</p>
                          <p class="text-sm text-gray-600 mt-2">Your payment is being reviewed. Access will be granted once approved.</p>
                        </div>
                        <button onclick="showPaymentModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors mr-2">
                          View Payment Details
                        </button>
                        <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                          Return to Homepage
                        </button>
                      </div>
                    `;
                    console.log('üö´ Course selection blocked for unapproved user');
                  }
                }).catch(error => {
                  console.error('Error checking payment status:', error);
                  alert('Error verifying access permissions. Please contact admin.');
                });
              } else {
                // Anonymous users can browse course listings but not access content
                handleCourseSelection(courseBtn.dataset.courseId);
              }
              return;
            }
            const mainCourseItem = e.target.closest('.course-item-main');
            if (mainCourseItem && !e.target.closest('.semesters-list-main')) {
              e.preventDefault();
              const courseId = mainCourseItem.dataset.courseId;
              // Check if user has permission to access course content
              if (user && user.email === 'kaigwaakram123@gmail.com') {
                handleCourseSelection(courseId); // Admin has full access
              } else if (user && !user.isAnonymous) {
                // Check payment status for regular users - BLOCK unapproved users
                checkPaymentStatus(user.uid).then(paymentStatus => {
                  if (paymentStatus.hasPaid || paymentStatus.status === 'none') {
                    handleCourseSelection(courseId); // User has approved payment or legacy access
                  } else {
                    // User has pending payment - BLOCK access completely
                    mainContent.innerHTML = `
                      <div class="p-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-xl shadow-lg w-full max-w-md mx-auto text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">‚õî Access Denied</h2>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                          <p class="text-gray-700 font-semibold">You must wait for admin approval before accessing course content.</p>
                          <p class="text-sm text-gray-600 mt-2">Your payment is being reviewed. Access will be granted once approved.</p>
                        </div>
                        <button onclick="showPaymentModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors mr-2">
                          View Payment Details
                        </button>
                        <button onclick="goToPage('home')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors">
                          Return to Homepage
                        </button>
                      </div>
                    `;
                    console.log('üö´ Main course selection blocked for unapproved user');
                  }
                }).catch(error => {
                  console.error('Error checking payment status:', error);
                  alert('Error verifying access permissions. Please contact admin.');
                });
              } else {
                // Anonymous users can browse course listings but not access content
                handleCourseSelection(courseId);
              }
              return;
            }
            const semesterBtn = e.target.closest('.select-semester');
            if (semesterBtn) {
              e.preventDefault();
              handleSemesterSelection(semesterBtn.dataset.semesterId);
              return;
            }
            const mainSemesterDiv = e.target.closest('.select-semester-main');
            if (mainSemesterDiv) {
              handleSemesterSelection(mainSemesterDiv.dataset.semesterId, false, true);
              return;
            }
            const sidebarSemesterBtn = e.target.closest('.sidebar-semester');
            if (sidebarSemesterBtn) {
              handleSemesterSelection(sidebarSemesterBtn.dataset.semesterId, true);
              return;
            }
            const courseUnitBtn = e.target.closest('.select-courseunit');
            if (courseUnitBtn) {
              e.preventDefault();
              handleCourseUnitSelection(courseUnitBtn.dataset.courseunitId);
              return;
            }
            const viewDocBtn = e.target.closest('.view-doc');
            if (viewDocBtn) {
              e.preventDefault();
              try {
                const rawJson = viewDocBtn.dataset.doc.replace(/"/g, '"');
                const docData = JSON.parse(rawJson);
                await handleViewDocument(docData);
              } catch (err) {
                console.error('Error parsing or accessing document data:', err);
              }
              return;
            }
            const downloadDocBtn = e.target.closest('.download-doc');
            if (downloadDocBtn) {
              e.preventDefault();
              try {
                const rawJson = downloadDocBtn.dataset.doc.replace(/"/g, '"');
                const docData = JSON.parse(rawJson);
                await handleDownloadDocument(docData);
              } catch (err) {
                console.error('Error parsing or accessing document data:', err);
              }
              return;
            }
            const backHomeBtn = e.target.closest('.back-home');
            if (backHomeBtn) {
              e.preventDefault();
              goToPage('home');
              return;
            }
            if (e.target.id === 'clear-sample-data') {
              e.preventDefault();
              if (confirm('This will permanently delete only the seeded sample data from the RESOURCES_STUDYPEDIA collection in Firebase, preserving your manually added content. This cannot be undone. Are you sure?')) {
                e.target.disabled = true;
                e.target.textContent = 'Clearing... Please wait';
                cleanupSampleData();
              }
              return;
            }

            // Auth button handlers
            if (e.target.id === 'login-button') {
              showModal(loginModal);
            } else if (e.target.id === 'register-button') {
              showModal(registerModal);
            } else if (e.target.id === 'logout-button') {
              if (confirm('Are you sure you want to logout?')) {
                // Hide admin buttons before logout
                hideAdminButtons();
                auth.signOut();
              }
            } else if (e.target.id === 'seed-clt-button') {
              // Seed CLT button deactivated - no action
              console.log('Seed CLT button is deactivated');
            } else if (e.target.id === 'seed-diploma-button') {
              // Seed Diplomas button deactivated - no action
              console.log('Seed Diplomas button is deactivated');
            } else if (e.target.id === 'close-login-modal' || e.target.closest('#menu-overlay')) {
              hideModal(loginModal);
            } else if (e.target.id === 'close-register-modal' || e.target.closest('#menu-overlay')) {
              hideModal(registerModal);
            } else if (e.target.id === 'switch-to-register') {
              hideModal(loginModal);
              showModal(registerModal);
            } else if (e.target.id === 'switch-to-login') {
              hideModal(registerModal);
              showModal(loginModal);
            } else if (loginForm && loginForm.contains(e.target) && e.target.type === 'submit') {
              e.preventDefault();
              const email = document.getElementById('login-email').value;
              const password = document.getElementById('login-password').value;
              if (email && password) {
                loginUser(email, password);
              } else {
                alert('Please fill in all fields.');
              }
            } else if (registerForm && registerForm.contains(e.target) && e.target.type === 'submit') {
              e.preventDefault();
              const email = document.getElementById('register-email').value;
              const password = document.getElementById('register-password').value;
              const confirmPassword = document.getElementById('register-confirm-password').value;
              if (email && password && confirmPassword) {
                if (password !== confirmPassword) {
                  alert('Passwords do not match.');
                  return;
                }
                if (password.length < 6) {
                  alert('Password must be at least 6 characters.');
                  return;
                }
                registerUser(email, password);
              } else {
                alert('Please fill in all fields.');
              }
            } else if (e.target.id === 'close-payment-modal') {
              hidePaymentModal();
            } else if (e.target.id === 'contact-admin') {
              window.open('https://wa.me/0756454646', '_blank');
            } else if (e.target.id === 'logout-instead') {
              if (confirm('Are you sure you want to logout instead of completing payment?')) {
                auth.signOut();
                hidePaymentModal();
              }
            } else if (paymentForm && paymentForm.contains(e.target) && e.target.type === 'submit') {
              handlePaymentSubmission(e);
            } else if (e.target.id === 'view-pending-payments') {
              showPendingPaymentsPanel();
            } else if (e.target.id === 'view-approved-payments') {
              showApprovedPaymentsPanel();
            } else if (e.target.id === 'admin-dashboard-button') {
              goToPage('admin-dashboard', true);
            } else if (e.target.id === 'admin-access-button') {
              goToPage('admin-dashboard', false);
            } else if (e.target.id === 'bulk-approve') {
              bulkApproveUsers();
            } else if (e.target.id === 'bulk-reject') {
              bulkRejectUsers();
            }
          }
        });

      } catch (e) {
        console.error("‚ùå Firebase initialization failed:", e);
        mainContent.innerHTML = `<div class="p-8 bg-red-100 text-red-800 rounded-xl shadow-lg w-full"><h2 class="font-bold text-xl mb-2">Initialization Failed</h2><p>Could not initialize Firebase. Please check your configuration and network connection.</p><p>Error: ${e.message}</p></div>`;
      }
    });
  </script>
</body>

</html>
